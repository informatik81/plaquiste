<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#080c14">
<title>PlaquistePro ERP</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --font:'Plus Jakarta Sans',sans-serif;
  --mono:'JetBrains Mono',monospace;
  --ease:cubic-bezier(.4,0,.2,1);
  --r:12px; --r-lg:18px; --r-xl:24px;
}
[data-theme="dark"] {
  --bg:#080c14; --bg2:#0d1220; --surf:#111827; --surf2:#1a2235; --surf3:#202c42;
  --border:#1e2d47; --border2:#2a3d5c;
  --text:#f0f4ff; --text2:#8899bb; --text3:#3d5070;
  --accent:#3b82f6; --accent2:#1d4ed8; --cyan:#06b6d4;
  --amber:#f59e0b; --green:#10b981; --red:#ef4444; --purple:#8b5cf6;
  --glow:rgba(59,130,246,.1);
  --shadow:rgba(0,0,0,.4);
}
[data-theme="light"] {
  --bg:#f1f5fb; --bg2:#e8edf8; --surf:#ffffff; --surf2:#f4f7ff; --surf3:#edf0fb;
  --border:#dde3f0; --border2:#c5cfe8;
  --text:#0f172a; --text2:#4a5982; --text3:#94a3b8;
  --accent:#2563eb; --accent2:#1d4ed8; --cyan:#0891b2;
  --amber:#d97706; --green:#059669; --red:#dc2626; --purple:#7c3aed;
  --glow:rgba(37,99,235,.07);
  --shadow:rgba(0,0,0,.1);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET + BASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{height:100%;-webkit-text-size-adjust:100%;}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;
  -webkit-font-smoothing:antialiased;overflow:hidden;
  transition:background .25s var(--ease),color .25s var(--ease);}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
::-webkit-scrollbar-track{background:transparent;}
input,select,textarea,button{font-family:var(--font);}
a{color:inherit;text-decoration:none;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app{display:flex;height:100vh;overflow:hidden;}

/* â”€â”€ AUTH SCREEN â”€â”€ */
#auth-screen{
  position:fixed;inset:0;z-index:1000;
  background:var(--bg);
  display:flex;align-items:center;justify-content:center;padding:20px;
}
#auth-screen.hidden{display:none;}

.auth-card{
  width:100%;max-width:400px;
  background:var(--surf);border:1px solid var(--border);
  border-radius:var(--r-xl);padding:36px;
  box-shadow:0 24px 80px var(--shadow);
}
.auth-logo{text-align:center;margin-bottom:32px;}
.auth-logo-icon{
  width:64px;height:64px;border-radius:16px;margin:0 auto 14px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;font-size:28px;
  box-shadow:0 8px 24px rgba(59,130,246,.4);
}
.auth-logo h1{font-size:26px;font-weight:800;letter-spacing:-.5px;}
.auth-logo p{font-size:11px;color:var(--text2);font-family:var(--mono);letter-spacing:2px;margin-top:4px;}
.auth-err{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);
  border-radius:8px;padding:11px 14px;font-size:13px;color:#fca5a5;margin-bottom:14px;display:none;}
.auth-err.show{display:block;}

/* â”€â”€ SIDEBAR â”€â”€ */
#sidebar{
  width:220px;flex-shrink:0;background:var(--bg2);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  transition:transform .3s var(--ease);z-index:100;
}
.sb-logo{padding:18px 14px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);}
.sb-logo-icon{width:34px;height:34px;background:linear-gradient(135deg,var(--accent),var(--accent2));
  border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;
  box-shadow:0 3px 12px rgba(59,130,246,.35);}
.sb-logo-txt{font-size:14px;font-weight:800;letter-spacing:-.3px;}
.sb-logo-sub{font-size:9px;color:var(--text2);font-family:var(--mono);letter-spacing:.8px;}

.sb-nav{flex:1;padding:8px 6px;overflow-y:auto;}
.sb-section{font-size:9px;font-weight:700;color:var(--text3);
  letter-spacing:1.5px;text-transform:uppercase;padding:10px 8px 4px;font-family:var(--mono);}
.nav-item{
  display:flex;align-items:center;gap:8px;padding:9px 10px;
  border-radius:9px;cursor:pointer;color:var(--text2);font-size:13px;font-weight:500;
  transition:all .15s;margin-bottom:1px;position:relative;
}
.nav-item:hover{background:var(--surf2);color:var(--text);}
.nav-item.active{
  background:linear-gradient(135deg,rgba(59,130,246,.18),rgba(59,130,246,.07));
  color:var(--accent);border:1px solid rgba(59,130,246,.18);
}
.nav-item .ni{font-size:16px;width:20px;text-align:center;flex-shrink:0;}
.nav-badge{margin-left:auto;background:var(--red);color:#fff;
  font-size:9px;font-weight:700;font-family:var(--mono);
  min-width:16px;height:16px;border-radius:8px;
  display:flex;align-items:center;justify-content:center;padding:0 3px;}

.sb-foot{padding:8px 6px 12px;border-top:1px solid var(--border);}
.user-card{display:flex;align-items:center;gap:8px;padding:9px 10px;
  border-radius:9px;cursor:pointer;background:var(--surf2);
  border:1px solid var(--border);transition:border-color .15s;}
.user-card:hover{border-color:var(--accent);}
.uc-av{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;
  justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0;}
.uc-av.admin{background:linear-gradient(135deg,var(--accent),var(--purple));}
.uc-av.driver{background:linear-gradient(135deg,var(--green),var(--cyan));}
.uc-av.client{background:linear-gradient(135deg,var(--amber),var(--red));}
.uc-name{font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.uc-role{font-size:9px;color:var(--text2);font-family:var(--mono);}

/* â”€â”€ MAIN AREA â”€â”€ */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}

/* â”€â”€ TOPBAR â”€â”€ */
#topbar{
  height:54px;flex-shrink:0;background:var(--bg2);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 16px;gap:10px;
}
.tb-title{font-size:16px;font-weight:700;}
.tb-right{margin-left:auto;display:flex;align-items:center;gap:7px;}
.icon-btn{
  width:32px;height:32px;border-radius:8px;background:var(--surf2);
  border:1px solid var(--border);color:var(--text2);font-size:13px;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .15s;position:relative;flex-shrink:0;
}
.icon-btn:hover{border-color:var(--accent);color:var(--accent);}
.notif-dot{position:absolute;top:5px;right:5px;width:6px;height:6px;
  border-radius:50%;background:var(--red);border:1.5px solid var(--bg2);}

/* â”€â”€ PAGES â”€â”€ */
#content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.page{display:none;padding:18px;animation:pgIn .2s var(--ease);}
.page.active{display:block;}
@keyframes pgIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMPONENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--surf);border:1px solid var(--border);border-radius:var(--r-lg);padding:16px;transition:border-color .2s;}
.card:hover{border-color:var(--border2);}
.card-title{font-size:11px;font-weight:700;color:var(--text2);font-family:var(--mono);
  letter-spacing:.5px;text-transform:uppercase;margin-bottom:14px;
  display:flex;align-items:center;justify-content:space-between;gap:8px;}

/* â”€â”€ KPI â”€â”€ */
.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px;}
@media(max-width:1100px){.kpi-grid{grid-template-columns:repeat(2,1fr);}}
@media(max-width:600px){.kpi-grid{grid-template-columns:1fr 1fr;}}
.kpi{background:var(--surf);border:1px solid var(--border);border-radius:var(--r-lg);
  padding:16px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;}
.kpi::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;transition:height .2s;}
.kpi:hover{transform:translateY(-2px);box-shadow:0 6px 24px var(--shadow);}
.kpi:hover::after{height:5px;}
.kpi.blue::after{background:var(--accent);}
.kpi.green::after{background:var(--green);}
.kpi.amber::after{background:var(--amber);}
.kpi.red::after{background:var(--red);}
.kpi.purple::after{background:var(--purple);}
.kpi.cyan::after{background:var(--cyan);}
.kpi-ico{font-size:22px;margin-bottom:8px;}
.kpi-val{font-size:32px;font-weight:800;letter-spacing:-1.5px;line-height:1;margin-bottom:3px;}
.kpi-lbl{font-size:11px;color:var(--text2);}
.kpi-sub{font-size:10px;color:var(--text3);font-family:var(--mono);margin-top:4px;}
.kpi-trend{position:absolute;top:12px;right:12px;font-size:9px;font-weight:700;
  font-family:var(--mono);padding:2px 6px;border-radius:5px;}
.t-up{background:rgba(16,185,129,.12);color:var(--green);}
.t-dn{background:rgba(239,68,68,.1);color:var(--red);}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{padding:9px 15px;border-radius:9px;border:none;font-family:var(--font);
  font-size:13px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;
  gap:6px;transition:all .15s;white-space:nowrap;min-height:36px;}
.btn:active{transform:scale(.97);}
.btn-p{background:var(--accent);color:#fff;box-shadow:0 2px 8px rgba(59,130,246,.3);}
.btn-p:hover{background:var(--accent2);box-shadow:0 4px 16px rgba(59,130,246,.4);transform:translateY(-1px);}
.btn-g{background:var(--surf2);color:var(--text);border:1px solid var(--border);}
.btn-g:hover{border-color:var(--accent);color:var(--accent);}
.btn-d{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.2);}
.btn-d:hover{background:var(--red);color:#fff;}
.btn-ok{background:var(--green);color:#fff;}
.btn-ok:hover{filter:brightness(1.1);}
.btn-amber{background:rgba(245,158,11,.12);color:var(--amber);border:1px solid rgba(245,158,11,.2);}
.btn-sm{padding:5px 10px;font-size:11px;border-radius:7px;min-height:28px;}
.btn-xs{padding:3px 8px;font-size:10px;border-radius:6px;min-height:24px;}

/* â”€â”€ SECTION HEAD â”€â”€ */
.sec-head{display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap;}
.sec-title{font-size:20px;font-weight:800;letter-spacing:-.4px;}
.sec-actions{margin-left:auto;display:flex;gap:7px;flex-wrap:wrap;}

/* â”€â”€ SEARCH + FILTERS â”€â”€ */
.search-row{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;}
.search-inp{
  flex:1;min-width:160px;padding:9px 13px;
  background:var(--surf);border:1.5px solid var(--border);
  border-radius:9px;color:var(--text);font-size:13px;outline:none;
  transition:border-color .15s;
}
.search-inp:focus{border-color:var(--accent);}
.filter-row{display:flex;gap:5px;margin-bottom:12px;flex-wrap:wrap;overflow-x:auto;}
.filter-btn{
  padding:5px 13px;border-radius:20px;border:1.5px solid var(--border);
  font-size:11px;font-weight:600;cursor:pointer;background:var(--surf);
  color:var(--text2);font-family:var(--font);white-space:nowrap;
  transition:all .15s;
}
.filter-btn:hover{border-color:var(--accent);color:var(--accent);}
.filter-btn.on{background:var(--accent);color:#fff;border-color:var(--accent);}

/* â”€â”€ TABLE â”€â”€ */
.tbl-wrap{overflow-x:auto;border-radius:var(--r-lg);border:1px solid var(--border);}
table{width:100%;border-collapse:collapse;font-size:13px;}
thead tr{background:var(--surf2);border-bottom:2px solid var(--border);}
th{padding:10px 13px;text-align:left;font-size:10px;font-weight:700;
  color:var(--text2);font-family:var(--mono);letter-spacing:.5px;text-transform:uppercase;white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s;cursor:pointer;}
tbody tr:hover{background:var(--surf2);}
tbody tr:last-child{border-bottom:none;}
td{padding:11px 13px;vertical-align:middle;}
.td-bold{font-weight:700;}
.td-mono{font-family:var(--mono);font-size:11px;}
.td-gray{color:var(--text2);font-size:12px;}

/* â”€â”€ CHIPS â”€â”€ */
.chip{display:inline-flex;align-items:center;gap:4px;
  font-size:10px;font-family:var(--mono);font-weight:600;
  padding:3px 8px;border-radius:20px;white-space:nowrap;}
.ch-blue  {background:rgba(59,130,246,.12);color:var(--accent);border:1px solid rgba(59,130,246,.2);}
.ch-green {background:rgba(16,185,129,.1);color:var(--green);border:1px solid rgba(16,185,129,.2);}
.ch-amber {background:rgba(245,158,11,.12);color:var(--amber);border:1px solid rgba(245,158,11,.2);}
.ch-red   {background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.2);}
.ch-purple{background:rgba(139,92,246,.12);color:var(--purple);border:1px solid rgba(139,92,246,.2);}
.ch-gray  {background:var(--surf2);color:var(--text2);border:1px solid var(--border);}
.ch-cyan  {background:rgba(6,182,212,.1);color:var(--cyan);border:1px solid rgba(6,182,212,.2);}
.chip-dot{width:5px;height:5px;border-radius:50%;background:currentColor;}

/* â”€â”€ FORMS â”€â”€ */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
@media(max-width:600px){.form-grid{grid-template-columns:1fr;}}
.form-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
@media(max-width:700px){.form-grid-3{grid-template-columns:1fr 1fr;}}
.fg{display:flex;flex-direction:column;gap:6px;}
.fg label{font-size:10px;font-weight:700;color:var(--text2);
  font-family:var(--mono);letter-spacing:1px;text-transform:uppercase;}
.fg input,.fg select,.fg textarea{
  padding:10px 12px;background:var(--surf2);border:1.5px solid var(--border);
  border-radius:9px;color:var(--text);font-size:14px;outline:none;
  transition:all .15s;-webkit-appearance:none;
}
.fg input:focus,.fg select:focus,.fg textarea:focus{
  border-color:var(--accent);box-shadow:0 0 0 3px var(--glow);}
.fg select option{background:var(--surf);}
.fg textarea{resize:vertical;min-height:72px;font-size:13px;line-height:1.5;}
.fg-full{grid-column:1/-1;}
.input-hint{font-size:10px;color:var(--text3);font-family:var(--mono);}

/* â”€â”€ MODAL â”€â”€ */
.modal-ov{
  position:fixed;inset:0;z-index:500;
  background:rgba(0,0,0,.7);backdrop-filter:blur(6px);
  display:none;align-items:center;justify-content:center;padding:16px;
  overflow-y:auto;
}
.modal-ov.open{display:flex;animation:fadeIn .18s;}
.modal{
  background:var(--surf);border:1px solid var(--border);
  border-radius:var(--r-xl);padding:24px;
  width:100%;max-width:600px;
  box-shadow:0 24px 80px rgba(0,0,0,.5);
  animation:modalIn .2s var(--ease);
  position:relative;margin:auto;
}
.modal-lg{max-width:800px;}
.modal-sm{max-width:440px;}
@keyframes modalIn{from{opacity:0;transform:scale(.96)translateY(8px)}to{opacity:1;transform:none}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal-title{font-size:18px;font-weight:700;margin-bottom:18px;letter-spacing:-.3px;}
.modal-foot{display:flex;gap:8px;justify-content:flex-end;
  margin-top:18px;padding-top:14px;border-top:1px solid var(--border);}
.modal-close{position:absolute;top:16px;right:16px;
  width:28px;height:28px;border-radius:7px;background:var(--surf2);
  border:1px solid var(--border);color:var(--text2);font-size:14px;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .15s;}
.modal-close:hover{background:var(--red);color:#fff;border-color:var(--red);}

/* â”€â”€ PROGRESS â”€â”€ */
.prog-wrap{height:5px;background:var(--surf3);border-radius:3px;overflow:hidden;}
.prog-bar{height:100%;border-radius:3px;transition:width .4s var(--ease);}
.pb-ok{background:var(--green);}
.pb-low{background:var(--amber);}
.pb-crit{background:var(--red);}

/* â”€â”€ EMPTY STATE â”€â”€ */
.empty{text-align:center;padding:48px 20px;color:var(--text2);}
.empty-ico{font-size:48px;opacity:.15;margin-bottom:12px;}
.empty-ttl{font-size:16px;font-weight:700;color:var(--text);margin-bottom:6px;}
.empty-sub{font-size:13px;}

/* â”€â”€ TOAST â”€â”€ */
#toast-area{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
  z-index:9999;display:flex;flex-direction:column;gap:6px;align-items:center;pointer-events:none;}
.toast{background:var(--surf);border:1px solid var(--border2);color:var(--text);
  padding:10px 18px;border-radius:40px;font-size:13px;font-weight:600;
  box-shadow:0 8px 24px rgba(0,0,0,.3);animation:tIn .2s,tOut .25s 2.3s forwards;white-space:nowrap;}
.toast.ok{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.3);color:#6ee7b7;}
.toast.err{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.25);color:#fca5a5;}
.toast.info{background:rgba(59,130,246,.1);border-color:rgba(59,130,246,.25);color:#93c5fd;}
@keyframes tIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
@keyframes tOut{to{opacity:0;transform:translateY(8px)}}

/* â”€â”€ GRID LAYOUTS â”€â”€ */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.g3{display:grid;grid-template-columns:2fr 1fr;gap:12px;}
.g4{display:grid;grid-template-columns:3fr 1fr;gap:12px;}
@media(max-width:900px){.g2,.g3,.g4{grid-template-columns:1fr;}}

/* â”€â”€ DETAIL PANEL â”€â”€ */
.detail-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:18px;flex-wrap:wrap;}
.detail-name{font-size:22px;font-weight:800;letter-spacing:-.4px;margin-bottom:3px;}
.detail-sub{font-size:13px;color:var(--text2);font-family:var(--mono);}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
@media(max-width:550px){.detail-grid{grid-template-columns:1fr;}}
.detail-box{background:var(--surf2);border-radius:10px;padding:13px;}
.detail-box-lbl{font-size:9px;font-family:var(--mono);color:var(--text2);margin-bottom:5px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;}
.detail-box-val{font-size:14px;font-weight:600;}

/* â”€â”€ STOCK ITEM â”€â”€ */
.stock-row{display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid var(--border);}
.stock-row:last-child{border-bottom:none;}
.sr-name{font-size:13px;font-weight:600;flex:1;min-width:0;}
.sr-ref{font-size:10px;color:var(--text2);font-family:var(--mono);}

/* â”€â”€ TIMELINE â”€â”€ */
.tl{position:relative;padding-left:20px;}
.tl::before{content:'';position:absolute;left:6px;top:5px;bottom:5px;width:2px;background:var(--border);border-radius:1px;}
.tl-item{position:relative;padding-bottom:16px;}
.tl-item:last-child{padding-bottom:0;}
.tl-dot{position:absolute;left:-17px;top:3px;width:12px;height:12px;border-radius:50%;border:2px solid var(--bg2);}
.tl-t{font-size:10px;color:var(--text3);font-family:var(--mono);}
.tl-h{font-size:13px;font-weight:600;margin:2px 0;}
.tl-s{font-size:11px;color:var(--text2);}
.td-green{background:var(--green);}
.td-blue{background:var(--accent);animation:pulseD 1.5s infinite;}
.td-amber{background:var(--amber);}
.td-red{background:var(--red);}
@keyframes pulseD{0%,100%{box-shadow:0 0 0 0 rgba(59,130,246,.4)}50%{box-shadow:0 0 0 4px rgba(59,130,246,0)}}

/* â”€â”€ MOBILE â”€â”€ */
@media(max-width:768px){
  #sidebar{position:fixed;inset:0;width:240px;transform:translateX(-100%);}
  #sidebar.open{transform:none;}
  #overlay{display:block!important;}
  .page{padding:12px;}
  .kpi-grid{grid-template-columns:1fr 1fr;}
}
#overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99;backdrop-filter:blur(2px);}

/* â”€â”€ LOADING â”€â”€ */
.loading-wrap{display:flex;align-items:center;justify-content:center;padding:40px;gap:10px;color:var(--text2);}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ LIVRAISON CARD â”€â”€ */
.lv-card{background:var(--surf);border:1px solid var(--border);border-radius:var(--r);
  padding:13px;display:grid;grid-template-columns:4px 1fr auto;gap:11px;
  align-items:center;cursor:pointer;transition:all .15s;margin-bottom:7px;}
.lv-card:hover{border-color:var(--accent);transform:translateX(2px);}
.lv-bar{border-radius:2px;align-self:stretch;}
.lv-client{font-size:14px;font-weight:700;margin-bottom:2px;}
.lv-addr{font-size:11px;color:var(--text2);}
.lv-chips{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap;}

/* â”€â”€ TOURNEE CARD â”€â”€ */
.tour-card{background:var(--surf);border:1px solid var(--border);border-radius:var(--r-lg);
  padding:16px;margin-bottom:10px;cursor:pointer;transition:all .15s;}
.tour-card:hover{border-color:var(--accent);}
.tour-head{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.tour-num{width:36px;height:36px;border-radius:10px;flex-shrink:0;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:#fff;}
.tour-stops{display:flex;flex-direction:column;gap:6px;}
.stop-row{display:flex;align-items:center;gap:8px;padding:7px 10px;
  background:var(--surf2);border-radius:8px;font-size:12px;}
.stop-num{width:20px;height:20px;border-radius:50%;background:var(--accent);
  color:#fff;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}

/* â”€â”€ NOTIFICATION PANEL â”€â”€ */
.notif-panel{position:absolute;top:44px;right:0;z-index:200;width:290px;
  background:var(--surf);border:1px solid var(--border);border-radius:var(--r-lg);
  box-shadow:0 14px 44px var(--shadow);display:none;}
.notif-panel.open{display:block;animation:slideD .18s;}
@keyframes slideD{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:none}}
.np-hdr{padding:12px 14px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;}
.np-item{padding:10px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s;}
.np-item:hover{background:var(--surf2);}
.np-item:last-child{border-bottom:none;}
.np-title{font-size:12px;font-weight:600;margin-bottom:2px;}
.np-body{font-size:11px;color:var(--text2);}
.np-time{font-size:9px;color:var(--text3);font-family:var(--mono);margin-top:2px;}

/* â”€â”€ MAT LINES â”€â”€ */
.mat-line{display:flex;gap:7px;margin-bottom:7px;align-items:center;}
.mat-line input,.mat-line select{
  background:var(--surf2);border:1.5px solid var(--border);border-radius:8px;
  color:var(--text);font-family:var(--font);font-size:13px;padding:8px 10px;outline:none;
  transition:border-color .15s;}
.mat-line input:focus,.mat-line select:focus{border-color:var(--accent);}
.mat-name{flex:2;}
.mat-qty{width:70px;text-align:center;}
.mat-unit{width:90px;}
.btn-rm{width:28px;height:28px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);
  border-radius:7px;color:var(--red);cursor:pointer;display:flex;align-items:center;
  justify-content:center;font-size:14px;flex-shrink:0;transition:all .15s;}
.btn-rm:hover{background:var(--red);color:#fff;}

/* â”€â”€ CONFIRM DIALOG â”€â”€ */
.confirm-modal .modal-title{color:var(--red);}
</style>
</head>
<body>

<!-- OVERLAY mobile -->
<div id="overlay" onclick="closeSidebar()"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTH SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">
      <div class="auth-logo-icon">ğŸ—ï¸</div>
      <h1>PlaquistePro</h1>
      <p>ERP Â· LIVRAISONS</p>
    </div>
    <div class="auth-err" id="auth-err"></div>
    <div class="fg" style="margin-bottom:12px">
      <label>Adresse e-mail</label>
      <input type="email" id="auth-email" placeholder="nom@entreprise.fr" autocomplete="email">
    </div>
    <div class="fg" style="margin-bottom:18px">
      <label>Mot de passe</label>
      <input type="password" id="auth-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
    </div>
    <button class="btn btn-p" style="width:100%;justify-content:center;padding:13px" onclick="doLogin()" id="btn-login">
      Se connecter
    </button>
    <div style="text-align:center;margin-top:16px;font-size:11px;color:var(--text3);font-family:var(--mono)">
      PlaquistePro ERP v1.0 Â· Firebase transport-8a0ce
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app" style="display:none">

<!-- SIDEBAR -->
<aside id="sidebar">
  <div class="sb-logo">
    <div class="sb-logo-icon">ğŸ—ï¸</div>
    <div>
      <div class="sb-logo-txt">PlaquistePro</div>
      <div class="sb-logo-sub">ERP v1.0</div>
    </div>
  </div>
  <nav class="sb-nav" id="sb-nav"></nav>
  <div class="sb-foot">
    <div class="user-card" onclick="openModal('modal-profile')">
      <div class="uc-av admin" id="uc-av">AD</div>
      <div style="min-width:0">
        <div class="uc-name" id="uc-name">Chargement...</div>
        <div class="uc-role" id="uc-role">â€”</div>
      </div>
    </div>
  </div>
</aside>

<!-- MAIN -->
<div id="main">
  <!-- TOPBAR -->
  <div id="topbar">
    <button class="icon-btn" onclick="toggleSidebar()">â˜°</button>
    <div class="tb-title" id="tb-title">Dashboard</div>
    <div class="tb-right">
      <button class="icon-btn" onclick="toggleTheme()" id="btn-theme">ğŸŒ™</button>
      <div style="position:relative">
        <button class="icon-btn" onclick="toggleNotifs()" id="btn-notif">
          ğŸ””<div class="notif-dot" id="notif-dot" style="display:none"></div>
        </button>
        <div class="notif-panel" id="notif-panel">
          <div class="np-hdr">
            <span style="font-weight:700;font-size:13px">Notifications</span>
            <button class="btn btn-g btn-sm" onclick="clearNotifs()">Effacer</button>
          </div>
          <div id="notif-list"><div class="empty" style="padding:20px"><div class="empty-sub">Aucune notification</div></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTENT -->
  <div id="content">

    <!-- â•â• DASHBOARD â•â• -->
    <div id="page-dashboard" class="page active">
      <div class="kpi-grid" id="kpi-grid"></div>
      <div class="g3">
        <div>
          <div class="card" style="margin-bottom:12px">
            <div class="card-title">ğŸš› Livraisons rÃ©centes</div>
            <div id="dash-recent-del"></div>
          </div>
          <div class="card">
            <div class="card-title">ğŸ• ActivitÃ© rÃ©cente</div>
            <div class="tl" id="dash-timeline"></div>
          </div>
        </div>
        <div>
          <div class="card" style="margin-bottom:12px">
            <div class="card-title">âš ï¸ Stock faible</div>
            <div id="dash-stock-low"></div>
          </div>
          <div class="card">
            <div class="card-title">ğŸ“‹ Incidents ouverts</div>
            <div id="dash-incidents"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â• CLIENTS â•â• -->
    <div id="page-clients" class="page">
      <div class="sec-head">
        <span class="sec-title">ğŸ‘¥ Clients</span>
        <div class="sec-actions">
          <button class="btn btn-p btn-sm" onclick="openModal('modal-client-form');clientFormMode('new')">ï¼‹ Nouveau client</button>
        </div>
      </div>
      <div class="search-row">
        <input class="search-inp" type="search" placeholder="ğŸ” Rechercher par nom, email, SIRET..." oninput="renderClients(this.value)" id="search-clients">
      </div>
      <div class="filter-row" id="clients-filter-row">
        <button class="filter-btn on" onclick="setClientFilter('all',this)">Tous</button>
        <button class="filter-btn" onclick="setClientFilter('active',this)">âœ… Actifs</button>
        <button class="filter-btn" onclick="setClientFilter('inactive',this)">â›” Inactifs</button>
      </div>
      <div class="tbl-wrap">
        <table id="clients-table">
          <thead><tr>
            <th>Entreprise</th><th>Contact</th><th>TÃ©lÃ©phone</th><th>Ville</th>
            <th>Livraisons</th><th>Statut</th><th>Actions</th>
          </tr></thead>
          <tbody id="clients-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- â•â• MARCHANDISES â•â• -->
    <div id="page-marchandises" class="page">
      <div class="sec-head">
        <span class="sec-title">ğŸ“¦ Marchandises</span>
        <div class="sec-actions">
          <button class="btn btn-g btn-sm" onclick="openModal('modal-mouvement')">ğŸ“¥ Mouvement stock</button>
          <button class="btn btn-p btn-sm" onclick="openModal('modal-product-form');productFormMode('new')">ï¼‹ Nouveau produit</button>
        </div>
      </div>
      <div class="search-row">
        <input class="search-inp" type="search" placeholder="ğŸ” Rechercher par nom, rÃ©fÃ©rence, catÃ©gorie..." oninput="renderProducts(this.value)" id="search-products">
        <select class="search-inp" style="flex:0;min-width:140px" onchange="renderProducts()" id="filter-cat-select">
          <option value="">Toutes catÃ©gories</option>
          <option value="plaques">Plaques</option>
          <option value="ossature">Ossature</option>
          <option value="enduits">Enduits</option>
          <option value="isolation">Isolation</option>
          <option value="visserie">Visserie</option>
          <option value="divers">Divers</option>
        </select>
      </div>
      <div class="filter-row">
        <button class="filter-btn on" onclick="setProductFilter('all',this)">Tous</button>
        <button class="filter-btn" onclick="setProductFilter('low',this)">âš ï¸ Stock faible</button>
        <button class="filter-btn" onclick="setProductFilter('ok',this)">âœ… Stock OK</button>
      </div>
      <div class="tbl-wrap">
        <table>
          <thead><tr>
            <th>Produit</th><th>RÃ©fÃ©rence</th><th>CatÃ©gorie</th><th>Stock</th>
            <th>Seuil min.</th><th>P.U.</th><th>Statut</th><th>Actions</th>
          </tr></thead>
          <tbody id="products-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- â•â• LIVRAISONS â•â• -->
    <div id="page-livraisons" class="page">
      <div class="sec-head">
        <span class="sec-title">ğŸš› Livraisons</span>
        <div class="sec-actions">
          <button class="btn btn-p btn-sm" onclick="openModal('modal-livraison-form');livraisonFormMode('new')">ï¼‹ Nouvelle livraison</button>
        </div>
      </div>
      <div class="search-row">
        <input class="search-inp" type="search" placeholder="ğŸ” Client, adresse, rÃ©fÃ©rence..." oninput="renderLivraisons(this.value)" id="search-livraisons">
      </div>
      <div class="filter-row">
        <button class="filter-btn on" onclick="setLivFilter('all',this)">Toutes</button>
        <button class="filter-btn" onclick="setLivFilter('pending',this)">â³ En attente</button>
        <button class="filter-btn" onclick="setLivFilter('assigned',this)">ğŸ“‹ AssignÃ©es</button>
        <button class="filter-btn" onclick="setLivFilter('in_transit',this)">ğŸš› Transit</button>
        <button class="filter-btn" onclick="setLivFilter('delivered',this)">âœ… LivrÃ©es</button>
        <button class="filter-btn" onclick="setLivFilter('incident',this)">âš ï¸ Incidents</button>
      </div>
      <div id="livraisons-list"></div>
    </div>

    <!-- â•â• TOURNEES â•â• -->
    <div id="page-tournees" class="page">
      <div class="sec-head">
        <span class="sec-title">ğŸ—ºï¸ TournÃ©es</span>
        <div class="sec-actions">
          <button class="btn btn-p btn-sm" onclick="openModal('modal-tournee-form')">ï¼‹ Nouvelle tournÃ©e</button>
        </div>
      </div>
      <div id="tournees-list"></div>
    </div>

    <!-- â•â• EQUIPE (chauffeurs) â•â• -->
    <div id="page-equipe" class="page">
      <div class="sec-head">
        <span class="sec-title">ğŸ‘¤ Ã‰quipe</span>
        <div class="sec-actions">
          <button class="btn btn-p btn-sm" onclick="openModal('modal-driver-form');driverFormMode('new')">ï¼‹ Nouveau membre</button>
        </div>
      </div>
      <div class="search-row">
        <input class="search-inp" type="search" placeholder="ğŸ” Rechercher..." oninput="renderDrivers(this.value)" id="search-drivers">
      </div>
      <div class="tbl-wrap">
        <table>
          <thead><tr>
            <th>Nom</th><th>RÃ´le</th><th>TÃ©lÃ©phone</th><th>Email</th>
            <th>Livraisons</th><th>Statut</th><th>Actions</th>
          </tr></thead>
          <tbody id="drivers-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- â•â• INCIDENTS â•â• -->
    <div id="page-incidents" class="page">
      <div class="sec-head">
        <span class="sec-title">ğŸš¨ Incidents</span>
      </div>
      <div class="filter-row">
        <button class="filter-btn on" onclick="setIncFilter('all',this)">Tous</button>
        <button class="filter-btn" onclick="setIncFilter('open',this)">ğŸ”´ Ouverts</button>
        <button class="filter-btn" onclick="setIncFilter('in_review',this)">ğŸŸ¡ En cours</button>
        <button class="filter-btn" onclick="setIncFilter('resolved',this)">âœ… RÃ©solus</button>
      </div>
      <div id="incidents-list"></div>
    </div>

    <!-- â•â• PARAMETRES â•â• -->
    <div id="page-parametres" class="page">
      <div class="sec-head"><span class="sec-title">âš™ï¸ ParamÃ¨tres</span></div>
      <div class="g2">
        <div class="card">
          <div class="card-title">ğŸ¢ Entreprise</div>
          <div class="fg" style="margin-bottom:10px"><label>Nom de l'entreprise</label><input type="text" id="p-company" placeholder="PlaquistePro SAS"></div>
          <div class="fg" style="margin-bottom:10px"><label>Adresse</label><input type="text" id="p-addr" placeholder="12 Avenue des Artisans, Lyon"></div>
          <div class="fg" style="margin-bottom:10px"><label>TÃ©lÃ©phone</label><input type="tel" id="p-phone" placeholder="04 72 00 00 00"></div>
          <div class="fg" style="margin-bottom:14px"><label>SIRET</label><input type="text" id="p-siret" placeholder="123 456 789 00012"></div>
          <button class="btn btn-p btn-sm" onclick="saveSettings()">ğŸ’¾ Enregistrer</button>
        </div>
        <div class="card">
          <div class="card-title">ğŸ¨ Apparence</div>
          <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)">
            <div>
              <div style="font-size:13px;font-weight:600">Mode sombre</div>
              <div style="font-size:11px;color:var(--text2)">ThÃ¨me de l'interface</div>
            </div>
            <button class="btn btn-g btn-sm" onclick="toggleTheme()" id="p-theme-btn">ğŸŒ™ Sombre</button>
          </div>
          <div style="margin-top:16px">
            <div class="card-title">ğŸ“Š Statistiques base</div>
            <div id="p-stats"></div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->
</div><!-- /app -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Profile -->
<div class="modal-ov" id="modal-profile">
  <div class="modal modal-sm">
    <button class="modal-close" onclick="closeModal('modal-profile')">âœ•</button>
    <div class="modal-title">Mon profil</div>
    <div style="text-align:center;padding:12px 0 18px">
      <div class="uc-av admin" id="prf-av" style="width:56px;height:56px;font-size:20px;margin:0 auto 10px">AD</div>
      <div style="font-size:17px;font-weight:700" id="prf-name">â€”</div>
      <div style="font-size:12px;color:var(--text2);margin-top:3px" id="prf-email">â€”</div>
      <div style="margin-top:10px" id="prf-role"></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-g" onclick="closeModal('modal-profile')">Fermer</button>
      <button class="btn btn-d btn-sm" onclick="doLogout()">â†© DÃ©connexion</button>
    </div>
  </div>
</div>

<!-- Client Form -->
<div class="modal-ov" id="modal-client-form">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modal-client-form')">âœ•</button>
    <div class="modal-title" id="client-form-title">Nouveau client</div>
    <input type="hidden" id="cf-id">
    <div class="form-grid">
      <div class="fg"><label>Raison sociale *</label><input type="text" id="cf-company" placeholder="SARL Dupont BÃ¢timent"></div>
      <div class="fg"><label>Contact principal</label><input type="text" id="cf-contact" placeholder="Pierre Dupont"></div>
      <div class="fg"><label>Email</label><input type="email" id="cf-email" placeholder="contact@dupont.fr"></div>
      <div class="fg"><label>TÃ©lÃ©phone</label><input type="tel" id="cf-phone" placeholder="04 72 00 00 00"></div>
    </div>
    <div class="fg" style="margin-top:10px"><label>Adresse</label><input type="text" id="cf-address" placeholder="12 Rue des Chantiers, 69001 Lyon"></div>
    <div class="form-grid" style="margin-top:10px">
      <div class="fg"><label>Ville</label><input type="text" id="cf-city" placeholder="Lyon"></div>
      <div class="fg"><label>Code postal</label><input type="text" id="cf-zip" placeholder="69001"></div>
      <div class="fg"><label>SIRET</label><input type="text" id="cf-siret" placeholder="123 456 789 00012"></div>
      <div class="fg"><label>Statut</label>
        <select id="cf-status"><option value="active">âœ… Actif</option><option value="inactive">â›” Inactif</option></select>
      </div>
    </div>
    <div class="fg" style="margin-top:10px"><label>Notes</label><textarea id="cf-notes" placeholder="Informations complÃ©mentaires..."></textarea></div>
    <div class="modal-foot">
      <button class="btn btn-g" onclick="closeModal('modal-client-form')">Annuler</button>
      <button class="btn btn-p" onclick="saveClient()" id="btn-save-client">âœ“ Enregistrer</button>
    </div>
  </div>
</div>

<!-- Client Detail -->
<div class="modal-ov" id="modal-client-detail">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeModal('modal-client-detail')">âœ•</button>
    <div id="client-detail-content"></div>
  </div>
</div>

<!-- Product Form -->
<div class="modal-ov" id="modal-product-form">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modal-product-form')">âœ•</button>
    <div class="modal-title" id="product-form-title">Nouveau produit</div>
    <input type="hidden" id="pf-id">
    <div class="form-grid">
      <div class="fg"><label>Nom du produit *</label><input type="text" id="pf-name" placeholder="Plaque BA13 standard"></div>
      <div class="fg"><label>RÃ©fÃ©rence</label><input type="text" id="pf-ref" placeholder="PL-BA13-STD"></div>
      <div class="fg"><label>CatÃ©gorie *</label>
        <select id="pf-category">
          <option value="plaques">Plaques</option><option value="ossature">Ossature</option>
          <option value="enduits">Enduits</option><option value="isolation">Isolation</option>
          <option value="visserie">Visserie</option><option value="divers">Divers</option>
        </select>
      </div>
      <div class="fg"><label>UnitÃ© *</label>
        <select id="pf-unit">
          <option value="plaques">Plaques</option><option value="barres">Barres</option>
          <option value="sacs">Sacs</option><option value="panneaux">Panneaux</option>
          <option value="rouleaux">Rouleaux</option><option value="boÃ®tes">BoÃ®tes</option>
          <option value="piÃ¨ces">PiÃ¨ces</option><option value="mÂ²">mÂ²</option><option value="ml">ml</option>
        </select>
      </div>
      <div class="fg"><label>Stock actuel *</label><input type="number" id="pf-qty" min="0" value="0"></div>
      <div class="fg"><label>Seuil minimum *</label><input type="number" id="pf-min" min="0" value="10"></div>
      <div class="fg"><label>Prix unitaire (â‚¬ HT)</label><input type="number" id="pf-price" min="0" step="0.01" placeholder="0.00"></div>
      <div class="fg"><label>Emplacement entrepÃ´t</label><input type="text" id="pf-location" placeholder="AllÃ©e B - Rayon 3"></div>
    </div>
    <div class="fg" style="margin-top:10px"><label>Fournisseur</label><input type="text" id="pf-supplier" placeholder="Knauf, Siniat, Placo..."></div>
    <div class="modal-foot">
      <button class="btn btn-g" onclick="closeModal('modal-product-form')">Annuler</button>
      <button class="btn btn-p" onclick="saveProduct()" id="btn-save-product">âœ“ Enregistrer</button>
    </div>
  </div>
</div>

<!-- Mouvement stock -->
<div class="modal-ov" id="modal-mouvement">
  <div class="modal modal-sm">
    <button class="modal-close" onclick="closeModal('modal-mouvement')">âœ•</button>
    <div class="modal-title">ğŸ“¥ Mouvement de stock</div>
    <div class="fg" style="margin-bottom:10px"><label>Produit *</label>
      <select id="mv-product" onchange="updateMvUnit()"><option value="">â€” SÃ©lectionner â€”</option></select>
    </div>
    <div class="form-grid">
      <div class="fg"><label>Type *</label>
        <select id="mv-type">
          <option value="in">ğŸ“¥ EntrÃ©e (rÃ©ception)</option>
          <option value="out">ğŸ“¤ Sortie (correction)</option>
        </select>
      </div>
      <div class="fg"><label>QuantitÃ© *</label>
        <input type="number" id="mv-qty" min="1" value="1">
        <span class="input-hint" id="mv-unit-hint">unitÃ©s</span>
      </div>
    </div>
    <div class="fg" style="margin-top:10px"><label>Motif</label>
      <input type="text" id="mv-reason" placeholder="RÃ©ception commande, correction inventaire...">
    </div>
    <div class="modal-foot">
      <button class="btn btn-g" onclick="closeModal('modal-mouvement')">Annuler</button>
      <button class="btn btn-p" onclick="saveMouvement()">âœ“ Enregistrer</button>
    </div>
  </div>
</div>

<!-- Livraison Form -->
<div class="modal-ov" id="modal-livraison-form">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeModal('modal-livraison-form')">âœ•</button>
    <div class="modal-title" id="lf-title">Nouvelle livraison</div>
    <input type="hidden" id="lf-id">
    <div class="form-grid">
      <div class="fg"><label>Client *</label>
        <select id="lf-client"><option value="">â€” SÃ©lectionner â€”</option></select>
      </div>
      <div class="fg"><label>PrioritÃ©</label>
        <select id="lf-priority">
          <option value="normal">Normale</option>
          <option value="urgent">ğŸ”´ Urgente</option>
          <option value="low">Faible</option>
        </select>
      </div>
    </div>
    <div class="fg" style="margin-top:10px"><label>Adresse de livraison *</label>
      <input type="text" id="lf-address" placeholder="15 Rue des Artisans, 69003 Lyon">
    </div>
    <div class="form-grid" style="margin-top:10px">
      <div class="fg"><label>Chauffeur assignÃ©</label>
        <select id="lf-driver"><option value="">â€” Non assignÃ© â€”</option></select>
      </div>
      <div class="fg"><label>Date / Heure prÃ©vue *</label>
        <input type="datetime-local" id="lf-date">
      </div>
    </div>
    <div style="margin-top:14px">
      <label style="font-size:10px;font-weight:700;color:var(--text2);font-family:var(--mono);letter-spacing:1px;text-transform:uppercase;display:block;margin-bottom:8px">Marchandises *</label>
      <div id="lf-mat-lines"></div>
      <button class="btn btn-g btn-sm" style="margin-top:4px" onclick="addMatLine('lf-mat-lines')">ï¼‹ Ajouter une ligne</button>
    </div>
    <div class="fg" style="margin-top:12px"><label>Notes / Instructions</label>
      <textarea id="lf-notes" placeholder="Code portail, accÃ¨s, instructions de livraison..."></textarea>
    </div>
    <div class="modal-foot">
      <button class="btn btn-g" onclick="closeModal('modal-livraison-form')">Annuler</button>
      <button class="btn btn-p" onclick="saveLivraison()" id="btn-save-lv">âœ“ Enregistrer</button>
    </div>
  </div>
</div>

<!-- Livraison Detail -->
<div class="modal-ov" id="modal-livraison-detail">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeModal('modal-livraison-detail')">âœ•</button>
    <div id="lv-detail-content"></div>
  </div>
</div>

<!-- TournÃ©e Form -->
<div class="modal-ov" id="modal-tournee-form">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modal-tournee-form')">âœ•</button>
    <div class="modal-title">ğŸ—ºï¸ Nouvelle tournÃ©e</div>
    <div class="form-grid">
      <div class="fg"><label>Nom de la tournÃ©e *</label><input type="text" id="tf-name" placeholder="TournÃ©e Nord â€” 18/12"></div>
      <div class="fg"><label>Chauffeur *</label><select id="tf-driver"><option value="">â€” SÃ©lectionner â€”</option></select></div>
    </div>
    <div class="fg" style="margin-top:10px"><label>Date *</label><input type="date" id="tf-date"></div>
    <div style="margin-top:14px">
      <label style="font-size:10px;font-weight:700;color:var(--text2);font-family:var(--mono);letter-spacing:1px;text-transform:uppercase;display:block;margin-bottom:8px">Livraisons Ã  inclure</label>
      <div id="tf-livraisons-list" style="max-height:200px;overflow-y:auto;border:1px solid var(--border);border-radius:9px;padding:8px;"></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-g" onclick="closeModal('modal-tournee-form')">Annuler</button>
      <button class="btn btn-p" onclick="saveTournee()">âœ“ CrÃ©er la tournÃ©e</button>
    </div>
  </div>
</div>

<!-- Driver Form -->
<div class="modal-ov" id="modal-driver-form">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modal-driver-form')">âœ•</button>
    <div class="modal-title" id="driver-form-title">Nouveau membre</div>
    <input type="hidden" id="df-id">
    <div class="form-grid">
      <div class="fg"><label>PrÃ©nom *</label><input type="text" id="df-firstname" placeholder="Jean-Pierre"></div>
      <div class="fg"><label>Nom *</label><input type="text" id="df-lastname" placeholder="Martin"></div>
      <div class="fg"><label>Email *</label><input type="email" id="df-email" placeholder="jp.martin@plaquistepro.fr"></div>
      <div class="fg"><label>TÃ©lÃ©phone</label><input type="tel" id="df-phone" placeholder="06 12 34 56 78"></div>
      <div class="fg"><label>RÃ´le</label>
        <select id="df-role">
          <option value="driver">ğŸš› Chauffeur</option>
          <option value="admin">âš™ï¸ Admin</option>
          <option value="assistant">ğŸ“‹ Assistant</option>
        </select>
      </div>
      <div class="fg"><label>Statut</label>
        <select id="df-status"><option value="active">âœ… Actif</option><option value="inactive">â›” Inactif</option></select>
      </div>
    </div>
    <div class="fg" style="margin-top:10px"><label>Notes</label><textarea id="df-notes" placeholder="Permis, vÃ©hicule, informations..."></textarea></div>
    <div class="modal-foot">
      <button class="btn btn-g" onclick="closeModal('modal-driver-form')">Annuler</button>
      <button class="btn btn-p" onclick="saveDriver()" id="btn-save-driver">âœ“ Enregistrer</button>
    </div>
  </div>
</div>

<!-- Confirmer suppression -->
<div class="modal-ov" id="modal-confirm">
  <div class="modal modal-sm confirm-modal">
    <div class="modal-title" id="confirm-title">ğŸ—‘ï¸ Confirmer la suppression</div>
    <div style="font-size:14px;color:var(--text2);margin-bottom:18px" id="confirm-msg">Cette action est irrÃ©versible.</div>
    <div class="modal-foot">
      <button class="btn btn-g" onclick="closeModal('modal-confirm')">Annuler</button>
      <button class="btn btn-d" id="btn-confirm-ok">Confirmer</button>
    </div>
  </div>
</div>

<!-- Statut livraison -->
<div class="modal-ov" id="modal-lv-status">
  <div class="modal modal-sm">
    <button class="modal-close" onclick="closeModal('modal-lv-status')">âœ•</button>
    <div class="modal-title">Changer le statut</div>
    <input type="hidden" id="lv-status-id">
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
      <button class="btn btn-amber" style="justify-content:flex-start" onclick="updateLvStatus('pending')">â³ En attente</button>
      <button class="btn btn-g" style="justify-content:flex-start;border-color:var(--cyan);color:var(--cyan)" onclick="updateLvStatus('assigned')">ğŸ“‹ AssignÃ©e</button>
      <button class="btn btn-g" style="justify-content:flex-start;border-color:var(--accent);color:var(--accent)" onclick="updateLvStatus('in_transit')">ğŸš› En transit</button>
      <button class="btn btn-ok" style="justify-content:flex-start" onclick="updateLvStatus('delivered')">âœ… LivrÃ©e</button>
      <button class="btn btn-d" style="justify-content:flex-start" onclick="updateLvStatus('incident')">âš ï¸ Incident</button>
      <button class="btn btn-d" style="justify-content:flex-start;opacity:.7" onclick="updateLvStatus('cancelled')">âŒ AnnulÃ©e</button>
    </div>
    <div class="fg"><label>Note (optionnel)</label><input type="text" id="lv-status-note" placeholder="Commentaire sur le changement de statut..."></div>
  </div>
</div>

<div id="toast-area"></div>
</style>
<script type="module">
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, doc, addDoc, updateDoc, deleteDoc,
  onSnapshot, query, orderBy, where, serverTimestamp, increment,
  getDoc, getDocs, writeBatch
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBBRkVqz1TzTBvXWZUHhyLPFN4hV8mR0cg",
  authDomain: "transport-8a0ce.firebaseapp.com",
  projectId: "transport-8a0ce",
  storageBucket: "transport-8a0ce.appspot.com",
  messagingSenderId: "1234567890",
  appId: "1:1234567890:web:abcdef"
};

const app  = initializeApp(firebaseConfig);
const db   = getFirestore(app);
const auth = getAuth(app);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let STATE = {
  user: null,
  clients: [], products: [], livraisons: [], drivers: [], tournees: [], incidents: [],
  notifications: [],
  currentPage: 'dashboard',
  filters: { clients:'all', products:'all', livraisons:'all', incidents:'all', productCat:'' },
  unsubs: [],
  settings: { company:'PlaquistePro SAS', address:'', phone:'', siret:'' },
  matLineCount: 0,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAV CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const NAV_ADMIN = [
  { section: null },
  { id:'dashboard',    ico:'ğŸ ', lbl:'Dashboard' },
  { section:'GESTION' },
  { id:'clients',      ico:'ğŸ‘¥', lbl:'Clients',      badgeKey:'clients' },
  { id:'marchandises', ico:'ğŸ“¦', lbl:'Marchandises',  badgeKey:'stockLow' },
  { id:'livraisons',   ico:'ğŸš›', lbl:'Livraisons',    badgeKey:'livPending' },
  { id:'tournees',     ico:'ğŸ—ºï¸', lbl:'TournÃ©es' },
  { section:'Ã‰QUIPE' },
  { id:'equipe',       ico:'ğŸ‘¤', lbl:'Ã‰quipe' },
  { id:'incidents',    ico:'ğŸš¨', lbl:'Incidents',     badgeKey:'incidents' },
  { section:'SYSTÃˆME' },
  { id:'parametres',   ico:'âš™ï¸', lbl:'ParamÃ¨tres' },
];

const PAGE_TITLES = {
  dashboard:'Dashboard', clients:'Clients', marchandises:'Marchandises',
  livraisons:'Livraisons', tournees:'TournÃ©es', equipe:'Ã‰quipe',
  incidents:'Incidents', parametres:'ParamÃ¨tres'
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
onAuthStateChanged(auth, async user => {
  if (user) {
    try {
      const snap = await getDoc(doc(db, 'users', user.uid));
      STATE.user = snap.exists()
        ? { uid: user.uid, email: user.email, ...snap.data() }
        : { uid: user.uid, email: user.email, displayName: user.email.split('@')[0], role: 'admin' };
    } catch {
      STATE.user = { uid: user.uid, email: user.email, displayName: user.email.split('@')[0], role: 'admin' };
    }
    showApp();
  } else {
    showAuthScreen();
  }
});

window.doLogin = async () => {
  const email = document.getElementById('auth-email').value.trim();
  const pass  = document.getElementById('auth-pass').value;
  const btn   = document.getElementById('btn-login');
  const err   = document.getElementById('auth-err');
  if (!email || !pass) { showAuthErr('Renseignez votre e-mail et mot de passe.'); return; }
  btn.textContent = '...'; btn.disabled = true;
  err.classList.remove('show');
  try {
    await signInWithEmailAndPassword(auth, email, pass);
  } catch(e) {
    const msgs = {
      'auth/user-not-found':'Aucun compte pour cet e-mail.',
      'auth/wrong-password':'Mot de passe incorrect.',
      'auth/invalid-credential':'Identifiants incorrects.',
      'auth/too-many-requests':'Trop de tentatives. RÃ©essayez plus tard.',
      'auth/invalid-email':'Adresse e-mail invalide.',
    };
    showAuthErr(msgs[e.code] || 'Erreur de connexion. VÃ©rifiez vos identifiants.');
    btn.textContent = 'Se connecter'; btn.disabled = false;
  }
};

window.doLogout = async () => {
  STATE.unsubs.forEach(u => u());
  STATE.unsubs = [];
  await signOut(auth);
  closeModal('modal-profile');
};

document.getElementById('auth-pass').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });

function showAuthErr(msg) {
  const el = document.getElementById('auth-err');
  el.textContent = msg; el.classList.add('show');
}

function showAuthScreen() {
  document.getElementById('auth-screen').classList.remove('hidden');
  document.getElementById('app').style.display = 'none';
}

function showApp() {
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('app').style.display = 'flex';
  initApp();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initApp() {
  renderNav();
  updateUserCard();
  subscribeAll();
  showPage('dashboard');
  loadSettings();
  document.getElementById('lf-date').value = new Date().toISOString().slice(0,16);
  document.getElementById('tf-date').value = new Date().toISOString().slice(0,10);
}

function subscribeAll() {
  // Clients
  STATE.unsubs.push(onSnapshot(query(collection(db,'clients'),orderBy('createdAt','desc')), snap => {
    STATE.clients = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderClients(); renderDash(); populateClientSelects();
    updateNavBadges();
  }));
  // Products
  STATE.unsubs.push(onSnapshot(query(collection(db,'products'),orderBy('name')), snap => {
    STATE.products = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderProducts(); renderDash(); populateProductSelects();
    updateNavBadges();
  }));
  // Livraisons
  STATE.unsubs.push(onSnapshot(query(collection(db,'livraisons'),orderBy('createdAt','desc')), snap => {
    STATE.livraisons = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderLivraisons(); renderDash(); populateLivraisonsInTournee();
    updateNavBadges();
  }));
  // Drivers
  STATE.unsubs.push(onSnapshot(query(collection(db,'drivers'),orderBy('lastname')), snap => {
    STATE.drivers = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderDrivers(); populateDriverSelects();
  }));
  // Tournees
  STATE.unsubs.push(onSnapshot(query(collection(db,'tournees'),orderBy('date','desc')), snap => {
    STATE.tournees = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderTournees();
  }));
  // Incidents
  STATE.unsubs.push(onSnapshot(query(collection(db,'incidents'),orderBy('createdAt','desc')), snap => {
    STATE.incidents = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderIncidents(); renderDash();
    updateNavBadges();
  }));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNav() {
  let html = '';
  NAV_ADMIN.forEach(item => {
    if (item.section !== undefined) {
      html += item.section ? `<div class="sb-section">${item.section}</div>` : '<div style="height:4px"></div>';
    } else {
      const badge = getNavBadge(item.badgeKey);
      html += `<div class="nav-item ${item.id===STATE.currentPage?'active':''}" onclick="showPage('${item.id}')">
        <span class="ni">${item.ico}</span><span>${item.lbl}</span>
        ${badge ? `<span class="nav-badge">${badge}</span>` : ''}
      </div>`;
    }
  });
  document.getElementById('sb-nav').innerHTML = html;
}

function getNavBadge(key) {
  if (!key) return 0;
  switch(key) {
    case 'stockLow': return STATE.products.filter(p => p.quantity <= p.minQuantity).length;
    case 'livPending': return STATE.livraisons.filter(l => l.status==='pending'||l.status==='assigned').length;
    case 'incidents': return STATE.incidents.filter(i => i.status==='open').length;
    default: return 0;
  }
}

function updateNavBadges() { renderNav(); }

window.showPage = function(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const el = document.getElementById('page-'+id);
  if (el) el.classList.add('active');
  STATE.currentPage = id;
  document.getElementById('tb-title').textContent = PAGE_TITLES[id] || id;
  renderNav();
  if (window.innerWidth < 768) closeSidebar();
  if (id === 'parametres') renderParamStats();
};

function updateUserCard() {
  const u = STATE.user;
  if (!u) return;
  const initials = (u.displayName||u.email||'?').substring(0,2).toUpperCase();
  document.getElementById('uc-av').textContent  = initials;
  document.getElementById('uc-name').textContent = u.displayName || u.email;
  document.getElementById('uc-role').textContent = {admin:'Administrateur',driver:'Chauffeur',client:'Client'}[u.role]||u.role||'â€”';
  document.getElementById('prf-av').textContent  = initials;
  document.getElementById('prf-name').textContent = u.displayName || u.email;
  document.getElementById('prf-email').textContent = u.email;
  document.getElementById('prf-role').innerHTML  = `<span class="chip ${u.role==='admin'?'ch-purple':u.role==='driver'?'ch-green':'ch-blue'}">${{admin:'âš™ï¸ Administrateur',driver:'ğŸš› Chauffeur',client:'ğŸ‘¤ Client'}[u.role]||u.role}</span>`;
}

window.toggleSidebar = () => {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('overlay').style.display = document.getElementById('sidebar').classList.contains('open') ? 'block' : 'none';
};
window.closeSidebar = () => {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('overlay').style.display = 'none';
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDash() {
  const lv    = STATE.livraisons;
  const prod  = STATE.products;
  const inc   = STATE.incidents;
  const cli   = STATE.clients;
  const lowStock = prod.filter(p => p.quantity <= p.minQuantity).length;
  const openInc  = inc.filter(i => i.status==='open').length;

  document.getElementById('kpi-grid').innerHTML = [
    {cls:'blue',  ico:'ğŸ‘¥', val:cli.length,  lbl:'Clients',         sub:`${cli.filter(c=>c.status==='active').length} actifs`,     page:'clients'},
    {cls:'purple',ico:'ğŸ“¦', val:prod.length, lbl:'Produits',        sub:`${lowStock} alertes stock`,                              page:'marchandises'},
    {cls:'amber', ico:'ğŸš›', val:lv.filter(l=>['pending','assigned','in_transit'].includes(l.status)).length, lbl:'En cours', sub:`${lv.length} total`, page:'livraisons'},
    {cls:'green', ico:'âœ…', val:lv.filter(l=>l.status==='delivered').length, lbl:'LivrÃ©es', sub:`${lv.length?Math.round(lv.filter(l=>l.status==='delivered').length/lv.length*100):0}% taux`, page:'livraisons'},
    {cls:'red',   ico:'ğŸš¨', val:openInc,     lbl:'Incidents',       sub:'Ã  rÃ©soudre',                                             page:'incidents'},
    {cls:'cyan',  ico:'ğŸ—ºï¸', val:STATE.tournees.length, lbl:'TournÃ©es',sub:'crÃ©Ã©es',                                              page:'tournees'},
  ].map(k=>`<div class="kpi ${k.cls}" onclick="showPage('${k.page}')">
    <div class="kpi-ico">${k.ico}</div>
    <div class="kpi-val">${k.val}</div>
    <div class="kpi-lbl">${k.lbl}</div>
    <div class="kpi-sub">${k.sub}</div>
  </div>`).join('');

  // Recent livraisons
  const recLv = STATE.livraisons.slice(0,5);
  document.getElementById('dash-recent-del').innerHTML = recLv.length
    ? recLv.map(l => lvCardMini(l)).join('')
    : '<div class="empty" style="padding:20px"><div class="empty-sub">Aucune livraison</div></div>';

  // Timeline
  const recent = [...STATE.livraisons].sort((a,b)=>(b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0)).slice(0,5);
  document.getElementById('dash-timeline').innerHTML = recent.length
    ? recent.map(l => {
        const cfg = lvStatusCfg(l.status);
        return `<div class="tl-item">
          <div class="tl-dot td-${cfg.tl}"></div>
          <div class="tl-t">${tsRelative(l.updatedAt||l.createdAt)}</div>
          <div class="tl-h">${l.reference||l.id}</div>
          <div class="tl-s">${l.clientName||'â€”'} Â· ${cfg.label}</div>
        </div>`;
      }).join('')
    : '<div class="empty" style="padding:12px"><div class="empty-sub">Aucune activitÃ©</div></div>';

  // Stock low
  const lowItems = STATE.products.filter(p=>p.quantity<=p.minQuantity).slice(0,4);
  document.getElementById('dash-stock-low').innerHTML = lowItems.length
    ? lowItems.map(s => {
        const pct = Math.min(100, Math.round((s.quantity/Math.max(s.minQuantity,1))*100));
        const cls = s.quantity <= s.minQuantity*0.5 ? 'pb-crit' : 'pb-low';
        return `<div class="stock-row">
          <div style="flex:1;min-width:0">
            <div class="sr-name">${s.name}</div>
            <div class="prog-wrap" style="margin-top:5px"><div class="prog-bar ${cls}" style="width:${pct}%"></div></div>
          </div>
          <div style="text-align:right;flex-shrink:0">
            <div style="font-size:12px;font-weight:700;font-family:var(--mono);color:${s.quantity<=s.minQuantity*0.5?'var(--red)':'var(--amber)'}">${s.quantity}/${s.minQuantity}</div>
            <div style="font-size:10px;color:var(--text3)">${s.unit||''}</div>
          </div>
        </div>`;
      }).join('')
    : '<div style="color:var(--text2);font-size:12px;padding:8px 0;text-align:center">âœ… Tous les stocks sont OK</div>';

  // Incidents
  const openIncList = STATE.incidents.filter(i=>i.status==='open').slice(0,3);
  document.getElementById('dash-incidents').innerHTML = openIncList.length
    ? openIncList.map(i=>`<div style="padding:10px 0;border-bottom:1px solid var(--border)">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:3px;flex-wrap:wrap">
          <span style="font-size:12px;font-weight:700">${i.deliveryRef||'Livraison'}</span>
          <span class="chip ch-red">ğŸ”´ Ouvert</span>
        </div>
        <div style="font-size:12px;color:var(--text2)">${i.description||'â€”'}</div>
      </div>`).join('')
    : '<div style="color:var(--text2);font-size:12px;padding:8px 0;text-align:center">âœ… Aucun incident ouvert</div>';
}

function lvCardMini(l) {
  const cfg = lvStatusCfg(l.status);
  return `<div class="lv-card" onclick="openLivraisonDetail('${l.id}')">
    <div class="lv-bar" style="background:${cfg.color}"></div>
    <div>
      <div class="lv-client">${l.clientName||'â€”'}</div>
      <div class="lv-addr">ğŸ“ ${l.address||'â€”'}</div>
      <div class="lv-chips">
        <span class="chip ${cfg.chip}">${cfg.label}</span>
        ${l.priority==='urgent'?'<span class="chip ch-red">ğŸ”´ Urgent</span>':''}
        ${l.reference?`<span class="chip ch-gray">${l.reference}</span>`:''}
      </div>
    </div>
    <div style="font-size:10px;color:var(--text3);font-family:var(--mono);white-space:nowrap">${tsShort(l.scheduledAt)}</div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLIENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let clientFilter = 'all';
window.setClientFilter = (f, btn) => {
  clientFilter = f;
  document.querySelectorAll('#clients-filter-row .filter-btn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  renderClients();
};

window.renderClients = (search='') => {
  search = search || document.getElementById('search-clients')?.value || '';
  let list = STATE.clients;
  if (clientFilter !== 'all') list = list.filter(c=>c.status===clientFilter);
  if (search) {
    const q = search.toLowerCase();
    list = list.filter(c=>(c.company||'').toLowerCase().includes(q)||(c.contact||'').toLowerCase().includes(q)||(c.email||'').toLowerCase().includes(q)||(c.siret||'').includes(q));
  }
  const tbody = document.getElementById('clients-tbody');
  if (!tbody) return;
  tbody.innerHTML = list.length ? list.map(c => {
    const count = STATE.livraisons.filter(l=>l.clientId===c.id).length;
    return `<tr onclick="openClientDetail('${c.id}')">
      <td class="td-bold">${c.company||'â€”'}</td>
      <td>${c.contact||'â€”'}</td>
      <td class="td-mono">${c.phone||'â€”'}</td>
      <td class="td-gray">${c.city||'â€”'}</td>
      <td style="font-weight:700">${count}</td>
      <td><span class="chip ${c.status==='active'?'ch-green':'ch-red'}">${c.status==='active'?'âœ… Actif':'â›” Inactif'}</span></td>
      <td onclick="event.stopPropagation()"><div style="display:flex;gap:5px">
        <button class="btn btn-g btn-sm" onclick="editClient('${c.id}')">âœï¸</button>
        <button class="btn btn-d btn-sm" onclick="confirmDelete('client','${c.id}','${(c.company||'').replace(/'/g,"\\'")}')">ğŸ—‘ï¸</button>
      </div></td>
    </tr>`;
  }).join('')
  : `<tr><td colspan="7"><div class="empty"><div class="empty-ico">ğŸ‘¥</div><div class="empty-ttl">Aucun client trouvÃ©</div></div></td></tr>`;
};

window.clientFormMode = (mode, data={}) => {
  document.getElementById('client-form-title').textContent = mode==='new' ? 'ğŸ‘¥ Nouveau client' : 'âœï¸ Modifier le client';
  document.getElementById('btn-save-client').textContent = mode==='new' ? 'âœ“ CrÃ©er le client' : 'âœ“ Enregistrer';
  document.getElementById('cf-id').value       = data.id||'';
  document.getElementById('cf-company').value  = data.company||'';
  document.getElementById('cf-contact').value  = data.contact||'';
  document.getElementById('cf-email').value    = data.email||'';
  document.getElementById('cf-phone').value    = data.phone||'';
  document.getElementById('cf-address').value  = data.address||'';
  document.getElementById('cf-city').value     = data.city||'';
  document.getElementById('cf-zip').value      = data.zip||'';
  document.getElementById('cf-siret').value    = data.siret||'';
  document.getElementById('cf-status').value   = data.status||'active';
  document.getElementById('cf-notes').value    = data.notes||'';
};

window.saveClient = async () => {
  const id      = document.getElementById('cf-id').value;
  const company = document.getElementById('cf-company').value.trim();
  if (!company) { toast('Raison sociale requise','err'); return; }
  const data = {
    company, contact:document.getElementById('cf-contact').value.trim(),
    email:document.getElementById('cf-email').value.trim(),
    phone:document.getElementById('cf-phone').value.trim(),
    address:document.getElementById('cf-address').value.trim(),
    city:document.getElementById('cf-city').value.trim(),
    zip:document.getElementById('cf-zip').value.trim(),
    siret:document.getElementById('cf-siret').value.trim(),
    status:document.getElementById('cf-status').value,
    notes:document.getElementById('cf-notes').value.trim(),
    updatedAt:serverTimestamp(),
  };
  try {
    if (id) {
      await updateDoc(doc(db,'clients',id), data);
      toast('Client mis Ã  jour âœ…','ok');
    } else {
      await addDoc(collection(db,'clients'), {...data, createdAt:serverTimestamp()});
      toast('Client crÃ©Ã© âœ…','ok');
    }
    closeModal('modal-client-form');
  } catch(e) { toast(e.message,'err'); }
};

window.editClient = id => {
  const c = STATE.clients.find(x=>x.id===id);
  if (c) { clientFormMode('edit', c); openModal('modal-client-form'); }
};

window.openClientDetail = id => {
  const c = STATE.clients.find(x=>x.id===id); if (!c) return;
  const livs = STATE.livraisons.filter(l=>l.clientId===id);
  const statsCounts = {delivered:0,in_transit:0,pending:0,incident:0};
  livs.forEach(l=>{ if(statsCounts[l.status]!==undefined) statsCounts[l.status]++; });
  document.getElementById('client-detail-content').innerHTML = `
    <div class="detail-header">
      <div>
        <div class="detail-name">${c.company}</div>
        <div class="detail-sub">${c.siret ? 'SIRET: '+c.siret : c.email||'â€”'}</div>
      </div>
      <div style="display:flex;gap:7px;align-items:center;flex-wrap:wrap">
        <span class="chip ${c.status==='active'?'ch-green':'ch-red'}">${c.status==='active'?'âœ… Actif':'â›” Inactif'}</span>
        <button class="btn btn-g btn-sm" onclick="editClient('${c.id}');closeModal('modal-client-detail')">âœï¸ Modifier</button>
      </div>
    </div>
    <div class="detail-grid">
      <div class="detail-box"><div class="detail-box-lbl">Contact</div><div class="detail-box-val">${c.contact||'â€”'}</div></div>
      <div class="detail-box"><div class="detail-box-lbl">TÃ©lÃ©phone</div><div class="detail-box-val">${c.phone?`<a href="tel:${c.phone}" style="color:var(--accent)">${c.phone}</a>`:'â€”'}</div></div>
      <div class="detail-box"><div class="detail-box-lbl">Email</div><div class="detail-box-val" style="word-break:break-all">${c.email?`<a href="mailto:${c.email}" style="color:var(--accent)">${c.email}</a>`:'â€”'}</div></div>
      <div class="detail-box"><div class="detail-box-lbl">Adresse</div><div class="detail-box-val" style="font-size:13px">${[c.address,c.zip,c.city].filter(Boolean).join(', ')||'â€”'}</div></div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px">
      ${Object.entries(statsCounts).map(([s,v])=>{const cfg=lvStatusCfg(s);return`<div style="background:var(--surf2);border-radius:9px;padding:10px;text-align:center"><div style="font-size:20px;font-weight:800;color:${cfg.color}">${v}</div><div style="font-size:10px;color:var(--text2)">${cfg.label}</div></div>`}).join('')}
    </div>
    <div style="font-size:12px;font-weight:700;color:var(--text2);font-family:var(--mono);letter-spacing:.5px;text-transform:uppercase;margin-bottom:10px">Historique livraisons (${livs.length})</div>
    ${livs.slice(0,8).map(l=>lvCardMini(l)).join('')}
    ${c.notes?`<div class="detail-box" style="margin-top:10px"><div class="detail-box-lbl">Notes</div><div style="font-size:13px;white-space:pre-wrap">${c.notes}</div></div>`:''}
  `;
  openModal('modal-client-detail');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRODUITS / STOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let productFilter = 'all';
window.setProductFilter = (f,btn) => {
  productFilter = f;
  document.querySelectorAll('#page-marchandises .filter-btn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  renderProducts();
};

window.renderProducts = (search='') => {
  search = search || document.getElementById('search-products')?.value || '';
  const cat = document.getElementById('filter-cat-select')?.value || '';
  let list = STATE.products;
  if (productFilter==='low') list = list.filter(p=>p.quantity<=p.minQuantity);
  else if (productFilter==='ok') list = list.filter(p=>p.quantity>p.minQuantity);
  if (cat) list = list.filter(p=>p.category===cat);
  if (search) {
    const q = search.toLowerCase();
    list = list.filter(p=>(p.name||'').toLowerCase().includes(q)||(p.ref||'').toLowerCase().includes(q)||(p.category||'').toLowerCase().includes(q));
  }
  const tbody = document.getElementById('products-tbody');
  if (!tbody) return;
  const catColors = {plaques:'ch-blue',ossature:'ch-cyan',enduits:'ch-amber',isolation:'ch-purple',visserie:'ch-gray',divers:'ch-gray'};
  tbody.innerHTML = list.length ? list.map(p => {
    const pct = Math.min(100, Math.round((p.quantity/Math.max(p.minQuantity,1))*100));
    const cls = p.quantity<=p.minQuantity*0.5?'pb-crit':p.quantity<=p.minQuantity?'pb-low':'pb-ok';
    const isLow = p.quantity <= p.minQuantity;
    return `<tr onclick="editProduct('${p.id}')">
      <td>
        <div class="td-bold">${p.name}</div>
        ${p.supplier?`<div class="td-gray">${p.supplier}</div>`:''}
      </td>
      <td class="td-mono">${p.ref||'â€”'}</td>
      <td><span class="chip ${catColors[p.category]||'ch-gray'}">${p.category||'â€”'}</span></td>
      <td style="min-width:100px">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-weight:700;color:${p.quantity<=p.minQuantity*0.5?'var(--red)':p.quantity<=p.minQuantity?'var(--amber)':'var(--text)'}">${p.quantity}</span>
          <span class="td-gray">${p.unit||''}</span>
        </div>
        <div class="prog-wrap" style="margin-top:4px;width:80px"><div class="prog-bar ${cls}" style="width:${pct}%"></div></div>
      </td>
      <td class="td-mono">${p.minQuantity} ${p.unit||''}</td>
      <td class="td-mono">${p.price?p.price.toFixed(2)+' â‚¬':'â€”'}</td>
      <td>${isLow?`<span class="chip ${p.quantity<=p.minQuantity*0.5?'ch-red':'ch-amber'}">${p.quantity<=p.minQuantity*0.5?'ğŸ”´ Critique':'ğŸŸ¡ Faible'}</span>`:'<span class="chip ch-green">âœ… OK</span>'}</td>
      <td onclick="event.stopPropagation()"><div style="display:flex;gap:5px">
        <button class="btn btn-g btn-sm" onclick="editProduct('${p.id}')">âœï¸</button>
        <button class="btn btn-d btn-sm" onclick="confirmDelete('product','${p.id}','${(p.name||'').replace(/'/g,"\\'")}')">ğŸ—‘ï¸</button>
      </div></td>
    </tr>`;
  }).join('')
  : `<tr><td colspan="8"><div class="empty"><div class="empty-ico">ğŸ“¦</div><div class="empty-ttl">Aucun produit trouvÃ©</div></div></td></tr>`;
};

window.productFormMode = (mode, data={}) => {
  document.getElementById('product-form-title').textContent = mode==='new' ? 'ğŸ“¦ Nouveau produit' : 'âœï¸ Modifier le produit';
  document.getElementById('btn-save-product').textContent   = mode==='new' ? 'âœ“ Ajouter' : 'âœ“ Enregistrer';
  document.getElementById('pf-id').value       = data.id||'';
  document.getElementById('pf-name').value     = data.name||'';
  document.getElementById('pf-ref').value      = data.ref||'';
  document.getElementById('pf-category').value = data.category||'plaques';
  document.getElementById('pf-unit').value     = data.unit||'plaques';
  document.getElementById('pf-qty').value      = data.quantity??0;
  document.getElementById('pf-min').value      = data.minQuantity??10;
  document.getElementById('pf-price').value    = data.price||'';
  document.getElementById('pf-location').value = data.location||'';
  document.getElementById('pf-supplier').value = data.supplier||'';
};

window.editProduct = id => {
  const p = STATE.products.find(x=>x.id===id);
  if (p) { productFormMode('edit', p); openModal('modal-product-form'); }
};

window.saveProduct = async () => {
  const id   = document.getElementById('pf-id').value;
  const name = document.getElementById('pf-name').value.trim();
  if (!name) { toast('Nom du produit requis','err'); return; }
  const data = {
    name, ref:document.getElementById('pf-ref').value.trim(),
    category:document.getElementById('pf-category').value,
    unit:document.getElementById('pf-unit').value,
    quantity:parseInt(document.getElementById('pf-qty').value)||0,
    minQuantity:parseInt(document.getElementById('pf-min').value)||0,
    price:parseFloat(document.getElementById('pf-price').value)||0,
    location:document.getElementById('pf-location').value.trim(),
    supplier:document.getElementById('pf-supplier').value.trim(),
    updatedAt:serverTimestamp(),
  };
  try {
    if (id) { await updateDoc(doc(db,'products',id),data); toast('Produit mis Ã  jour âœ…','ok'); }
    else    { await addDoc(collection(db,'products'),{...data,createdAt:serverTimestamp()}); toast('Produit ajoutÃ© âœ…','ok'); }
    closeModal('modal-product-form');
  } catch(e) { toast(e.message,'err'); }
};

window.saveMouvement = async () => {
  const productId = document.getElementById('mv-product').value;
  const type      = document.getElementById('mv-type').value;
  const qty       = parseInt(document.getElementById('mv-qty').value)||0;
  const reason    = document.getElementById('mv-reason').value.trim();
  if (!productId||!qty) { toast('SÃ©lectionnez un produit et une quantitÃ©','err'); return; }
  const p = STATE.products.find(x=>x.id===productId);
  if (!p) return;
  const delta = type==='in' ? qty : -qty;
  const newQty = Math.max(0, (p.quantity||0) + delta);
  try {
    await updateDoc(doc(db,'products',productId), { quantity:newQty, updatedAt:serverTimestamp() });
    await addDoc(collection(db,'mouvements'), {
      productId, productName:p.name, type, qty, reason, newQty,
      userId:STATE.user?.uid, createdAt:serverTimestamp()
    });
    addNotif(`${type==='in'?'ğŸ“¥':'ğŸ“¤'} Stock ${type==='in'?'entrÃ©':'sorti'}`, `${qty} ${p.unit} Â· ${p.name}`, 'info');
    toast(`Stock mis Ã  jour : ${newQty} ${p.unit||''}`, 'ok');
    closeModal('modal-mouvement');
  } catch(e) { toast(e.message,'err'); }
};

window.updateMvUnit = () => {
  const id = document.getElementById('mv-product').value;
  const p  = STATE.products.find(x=>x.id===id);
  document.getElementById('mv-unit-hint').textContent = p ? `Stock actuel: ${p.quantity} ${p.unit}` : 'unitÃ©s';
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVRAISONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let livFilter = 'all';
window.setLivFilter = (f,btn) => {
  livFilter = f;
  document.querySelectorAll('#page-livraisons .filter-btn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  renderLivraisons();
};

window.renderLivraisons = (search='') => {
  search = search || document.getElementById('search-livraisons')?.value || '';
  let list = STATE.livraisons;
  if (livFilter!=='all') list = list.filter(l=>l.status===livFilter);
  if (search) {
    const q = search.toLowerCase();
    list = list.filter(l=>(l.clientName||'').toLowerCase().includes(q)||(l.address||'').toLowerCase().includes(q)||(l.reference||'').toLowerCase().includes(q));
  }
  const el = document.getElementById('livraisons-list');
  if (!el) return;
  el.innerHTML = list.length
    ? list.map(l=>lvCardFull(l)).join('')
    : `<div class="empty"><div class="empty-ico">ğŸš›</div><div class="empty-ttl">Aucune livraison trouvÃ©e</div><button class="btn btn-p btn-sm" style="margin-top:12px" onclick="openModal('modal-livraison-form');livraisonFormMode('new')">ï¼‹ Nouvelle livraison</button></div>`;
};

function lvCardFull(l) {
  const cfg = lvStatusCfg(l.status);
  const dt  = l.scheduledAt ? new Date(l.scheduledAt.seconds*1000).toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : 'â€”';
  return `<div class="lv-card" onclick="openLivraisonDetail('${l.id}')">
    <div class="lv-bar" style="background:${cfg.color}"></div>
    <div>
      <div class="lv-client">${l.clientName||'â€”'}</div>
      <div class="lv-addr">ğŸ“ ${l.address||'â€”'}</div>
      <div class="lv-chips">
        <span class="chip ${cfg.chip}">${cfg.label}</span>
        ${l.priority==='urgent'?'<span class="chip ch-red">ğŸ”´ Urgent</span>':''}
        ${l.reference?`<span class="chip ch-gray">${l.reference}</span>`:''}
        ${l.driverName?`<span class="chip ch-gray">ğŸš› ${l.driverName}</span>`:''}
        ${l.items?.length?`<span class="chip ch-gray">ğŸ“¦ ${l.items.length} article${l.items.length>1?'s':''}</span>`:''}
      </div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
      <span style="font-size:10px;color:var(--text3);font-family:var(--mono)">${dt}</span>
      <div style="display:flex;gap:5px" onclick="event.stopPropagation()">
        <button class="btn btn-g btn-xs" onclick="openStatusModal('${l.id}')">âŸ³ Statut</button>
        <button class="btn btn-g btn-xs" onclick="editLivraison('${l.id}')">âœï¸</button>
      </div>
    </div>
  </div>`;
}

window.livraisonFormMode = (mode, data={}) => {
  document.getElementById('lf-title').textContent    = mode==='new' ? 'ğŸš› Nouvelle livraison' : 'âœï¸ Modifier la livraison';
  document.getElementById('btn-save-lv').textContent = mode==='new' ? 'âœ“ CrÃ©er' : 'âœ“ Enregistrer';
  document.getElementById('lf-id').value      = data.id||'';
  document.getElementById('lf-client').value  = data.clientId||'';
  document.getElementById('lf-priority').value= data.priority||'normal';
  document.getElementById('lf-address').value = data.address||'';
  document.getElementById('lf-driver').value  = data.driverId||'';
  document.getElementById('lf-notes').value   = data.notes||'';
  if (data.scheduledAt) document.getElementById('lf-date').value = new Date(data.scheduledAt.seconds*1000).toISOString().slice(0,16);
  // Mat lines
  const container = document.getElementById('lf-mat-lines');
  container.innerHTML = '';
  STATE.matLineCount = 0;
  if (data.items?.length) data.items.forEach(it => addMatLine('lf-mat-lines', it));
  else { addMatLine('lf-mat-lines'); addMatLine('lf-mat-lines'); }
};

window.editLivraison = id => {
  const l = STATE.livraisons.find(x=>x.id===id);
  if (l) { livraisonFormMode('edit', l); openModal('modal-livraison-form'); }
};

window.saveLivraison = async () => {
  const id        = document.getElementById('lf-id').value;
  const clientId  = document.getElementById('lf-client').value;
  const address   = document.getElementById('lf-address').value.trim();
  const dateVal   = document.getElementById('lf-date').value;
  if (!clientId||!address||!dateVal) { toast('Client, adresse et date sont requis','err'); return; }
  const client   = STATE.clients.find(c=>c.id===clientId);
  const driverId = document.getElementById('lf-driver').value;
  const driver   = STATE.drivers.find(d=>d.id===driverId);
  // Collect mat lines
  const items = [];
  document.querySelectorAll('#lf-mat-lines .mat-line').forEach(row => {
    const n = row.querySelector('.mat-name')?.value?.trim();
    const q = parseInt(row.querySelector('.mat-qty')?.value)||0;
    const u = row.querySelector('.mat-unit')?.value?.trim();
    if (n && q) items.push({name:n, qty:q, unit:u||''});
  });
  if (!items.length) { toast('Ajoutez au moins un article','err'); return; }
  const data = {
    clientId, clientName:client?.company||'',
    address, priority:document.getElementById('lf-priority').value,
    driverId:driverId||null, driverName:driver?`${driver.firstname} ${driver.lastname}`:null,
    scheduledAt:new Date(dateVal),
    items, notes:document.getElementById('lf-notes').value.trim(),
    status:id?undefined:'pending',
    updatedAt:serverTimestamp(),
  };
  if (!id) { data.status = driverId ? 'assigned' : 'pending'; data.reference = genRef(); data.createdAt = serverTimestamp(); }
  try {
    if (id) { const d={...data}; delete d.status; await updateDoc(doc(db,'livraisons',id),d); toast('Livraison mise Ã  jour âœ…','ok'); }
    else    { await addDoc(collection(db,'livraisons'),data); toast('Livraison crÃ©Ã©e âœ…','ok');
      if (driverId) addNotif('ğŸš› Livraison assignÃ©e', `${data.reference} Â· ${client?.company}`, 'info');
    }
    closeModal('modal-livraison-form');
  } catch(e) { toast(e.message,'err'); }
};

window.openLivraisonDetail = id => {
  const l = STATE.livraisons.find(x=>x.id===id); if (!l) return;
  const cfg = lvStatusCfg(l.status);
  const client = STATE.clients.find(c=>c.id===l.clientId);
  const driver = STATE.drivers.find(d=>d.id===l.driverId);
  document.getElementById('lv-detail-content').innerHTML = `
    <div class="detail-header">
      <div>
        <div class="detail-name">${l.clientName||'â€”'}</div>
        <div class="detail-sub" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          ${l.reference?`<span style="font-family:var(--mono)">${l.reference}</span>`:''}
          ${l.priority==='urgent'?'<span class="chip ch-red">ğŸ”´ Urgent</span>':''}
        </div>
      </div>
      <div style="display:flex;gap:7px;align-items:center;flex-wrap:wrap">
        <span class="chip ${cfg.chip}" style="font-size:12px;padding:5px 12px">${cfg.label}</span>
        <button class="btn btn-g btn-sm" onclick="editLivraison('${l.id}');closeModal('modal-livraison-detail')">âœï¸</button>
        <button class="btn btn-amber btn-sm" onclick="openStatusModal('${l.id}');closeModal('modal-livraison-detail')">âŸ³ Statut</button>
      </div>
    </div>
    <div class="detail-grid">
      <div class="detail-box"><div class="detail-box-lbl">Adresse</div>
        <div class="detail-box-val" style="font-size:13px">${l.address||'â€”'}</div>
        <a href="https://waze.com/ul?q=${encodeURIComponent(l.address||'')}&navigate=yes" target="_blank" style="display:inline-flex;align-items:center;gap:4px;margin-top:7px;color:var(--cyan);font-size:12px;font-weight:600">ğŸ—ºï¸ Ouvrir Waze</a>
      </div>
      <div class="detail-box"><div class="detail-box-lbl">Chauffeur</div>
        <div class="detail-box-val">${l.driverName||'Non assignÃ©'}</div>
        ${driver?.phone?`<div style="margin-top:4px"><a href="tel:${driver.phone}" style="color:var(--accent);font-size:12px">ğŸ“ ${driver.phone}</a></div>`:''}
      </div>
      <div class="detail-box"><div class="detail-box-lbl">Date planifiÃ©e</div>
        <div class="detail-box-val" style="font-size:13px">${l.scheduledAt ? new Date(l.scheduledAt.seconds*1000).toLocaleDateString('fr-FR',{weekday:'long',day:'2-digit',month:'long',hour:'2-digit',minute:'2-digit'}) : 'â€”'}</div>
      </div>
      <div class="detail-box"><div class="detail-box-lbl">Client</div>
        <div class="detail-box-val">${l.clientName||'â€”'}</div>
        ${client?.phone?`<div style="margin-top:3px;font-size:12px;color:var(--text2)">${client.phone}</div>`:''}
      </div>
    </div>
    <div style="border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:12px">
      <div style="padding:10px 13px;background:var(--surf2);font-size:10px;font-weight:700;color:var(--text2);font-family:var(--mono);letter-spacing:.5px;border-bottom:1px solid var(--border)">
        ARTICLES (${(l.items||[]).length})
      </div>
      ${(l.items||[]).map(it=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 13px;border-bottom:1px solid var(--border)"><span style="font-size:13px">${it.name}</span><span class="chip ch-gray">${it.qty} ${it.unit||''}</span></div>`).join('')}
    </div>
    ${l.notes?`<div class="detail-box" style="margin-bottom:12px"><div class="detail-box-lbl">Notes</div><div style="font-size:13px">${l.notes}</div></div>`:''}
    ${l.incidentNote?`<div style="background:rgba(239,68,68,.07);border:1px solid rgba(239,68,68,.2);border-radius:10px;padding:12px;margin-bottom:12px"><div style="font-size:9px;font-family:var(--mono);color:var(--red);margin-bottom:4px">INCIDENT</div><div style="font-size:13px">${l.incidentNote}</div></div>`:''}
    <div style="display:flex;gap:7px;flex-wrap:wrap">
      <button class="btn btn-g btn-sm" onclick="copyAddr('${(l.address||'').replace(/'/g,"\\'")}')">ğŸ“‹ Copier adresse</button>
      <a href="https://waze.com/ul?q=${encodeURIComponent(l.address||'')}&navigate=yes" target="_blank" class="btn btn-g btn-sm">ğŸ—ºï¸ Waze</a>
      <button class="btn btn-d btn-sm" onclick="confirmDelete('livraison','${l.id}','${(l.reference||l.id).replace(/'/g,"\\'")}');closeModal('modal-livraison-detail')">ğŸ—‘ï¸ Supprimer</button>
    </div>`;
  openModal('modal-livraison-detail');
};

window.openStatusModal = id => {
  document.getElementById('lv-status-id').value = id;
  document.getElementById('lv-status-note').value = '';
  openModal('modal-lv-status');
};

window.updateLvStatus = async status => {
  const id   = document.getElementById('lv-status-id').value;
  const note = document.getElementById('lv-status-note').value.trim();
  if (!id) return;
  const data = { status, updatedAt:serverTimestamp() };
  if (note) data.statusNote = note;
  if (status==='delivered') data.deliveredAt = serverTimestamp();
  if (status==='incident' && note) data.incidentNote = note;
  try {
    await updateDoc(doc(db,'livraisons',id), data);
    const cfg = lvStatusCfg(status);
    addNotif('Livraison mise Ã  jour', `Statut â†’ ${cfg.label}`, 'info');
    toast(`Statut mis Ã  jour : ${cfg.label}`,'ok');
    // If delivered, decrement stock
    if (status==='delivered') {
      const l = STATE.livraisons.find(x=>x.id===id);
      if (l?.items) await decrementStock(l.items);
    }
    closeModal('modal-lv-status');
  } catch(e) { toast(e.message,'err'); }
};

async function decrementStock(items) {
  const batch = writeBatch(db);
  for (const item of items) {
    if (!item.productId) continue;
    const p = STATE.products.find(x=>x.id===item.productId);
    if (!p) continue;
    batch.update(doc(db,'products',item.productId), {
      quantity:Math.max(0,(p.quantity||0)-item.qty),
      updatedAt:serverTimestamp()
    });
  }
  await batch.commit();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOURNEES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.renderTournees = () => {
  const el = document.getElementById('tournees-list');
  if (!el) return;
  const list = STATE.tournees;
  el.innerHTML = list.length
    ? list.map((t,i)=>{
        const livs = (t.livraisonIds||[]).map(id=>STATE.livraisons.find(l=>l.id===id)).filter(Boolean);
        const driver = STATE.drivers.find(d=>d.id===t.driverId);
        return `<div class="tour-card">
          <div class="tour-head">
            <div class="tour-num">${i+1}</div>
            <div style="flex:1">
              <div style="font-size:15px;font-weight:700">${t.name||'TournÃ©e'}</div>
              <div style="font-size:12px;color:var(--text2);margin-top:2px">ğŸš› ${driver?driver.firstname+' '+driver.lastname:'Non assignÃ©'} Â· ğŸ“… ${t.date||'â€”'} Â· ${livs.length} arrÃªt${livs.length>1?'s':''}</div>
            </div>
            <button class="btn btn-d btn-sm" onclick="confirmDelete('tournee','${t.id}','${(t.name||'').replace(/'/g,"\\'")}')">ğŸ—‘ï¸</button>
          </div>
          <div class="tour-stops">
            ${livs.map((l,j)=>{const cfg=lvStatusCfg(l.status);return`<div class="stop-row">
              <div class="stop-num">${j+1}</div>
              <div style="flex:1">
                <div style="font-weight:600">${l.clientName||'â€”'}</div>
                <div style="font-size:11px;color:var(--text2)">ğŸ“ ${l.address||'â€”'}</div>
              </div>
              <span class="chip ${cfg.chip}" style="font-size:9px">${cfg.label}</span>
            </div>`;}).join('')}
          </div>
        </div>`;
      }).join('')
    : `<div class="empty"><div class="empty-ico">ğŸ—ºï¸</div><div class="empty-ttl">Aucune tournÃ©e crÃ©Ã©e</div><button class="btn btn-p btn-sm" style="margin-top:12px" onclick="openModal('modal-tournee-form')">ï¼‹ CrÃ©er une tournÃ©e</button></div>`;
};

function populateLivraisonsInTournee() {
  const el = document.getElementById('tf-livraisons-list');
  if (!el) return;
  const pending = STATE.livraisons.filter(l=>['pending','assigned'].includes(l.status));
  el.innerHTML = pending.length
    ? pending.map(l=>`<label style="display:flex;align-items:center;gap:9px;padding:8px 6px;cursor:pointer;border-radius:7px;transition:background .1s" onmouseover="this.style.background='var(--surf3)'" onmouseout="this.style.background=''">
        <input type="checkbox" value="${l.id}" style="accent-color:var(--accent)">
        <div><div style="font-size:13px;font-weight:600">${l.clientName||'â€”'}</div><div style="font-size:11px;color:var(--text2)">ğŸ“ ${l.address||'â€”'}</div></div>
      </label>`).join('')
    : '<div style="color:var(--text2);font-size:12px;padding:10px">Aucune livraison en attente</div>';
}

window.saveTournee = async () => {
  const name    = document.getElementById('tf-name').value.trim();
  const driverId= document.getElementById('tf-driver').value;
  const date    = document.getElementById('tf-date').value;
  if (!name||!driverId||!date) { toast('Nom, chauffeur et date requis','err'); return; }
  const ids = [...document.querySelectorAll('#tf-livraisons-list input:checked')].map(i=>i.value);
  if (!ids.length) { toast('SÃ©lectionnez au moins une livraison','err'); return; }
  const driver = STATE.drivers.find(d=>d.id===driverId);
  try {
    await addDoc(collection(db,'tournees'), {
      name, driverId, driverName:driver?`${driver.firstname} ${driver.lastname}`:'',
      date, livraisonIds:ids, status:'planned', createdAt:serverTimestamp()
    });
    // Assign driver to all selected livraisons
    const batch = writeBatch(db);
    ids.forEach(id => batch.update(doc(db,'livraisons',id), {driverId, driverName:driver?`${driver.firstname} ${driver.lastname}`:'', status:'assigned', updatedAt:serverTimestamp()}));
    await batch.commit();
    toast('TournÃ©e crÃ©Ã©e âœ…','ok');
    closeModal('modal-tournee-form');
  } catch(e) { toast(e.message,'err'); }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EQUIPE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.renderDrivers = (search='') => {
  search = search || document.getElementById('search-drivers')?.value || '';
  let list = STATE.drivers;
  if (search) {
    const q = search.toLowerCase();
    list = list.filter(d=>(d.firstname+' '+d.lastname).toLowerCase().includes(q)||(d.email||'').toLowerCase().includes(q));
  }
  const tbody = document.getElementById('drivers-tbody');
  if (!tbody) return;
  const roleLabel = {admin:'âš™ï¸ Admin',driver:'ğŸš› Chauffeur',assistant:'ğŸ“‹ Assistant'};
  tbody.innerHTML = list.length ? list.map(d => {
    const count = STATE.livraisons.filter(l=>l.driverId===d.id).length;
    return `<tr>
      <td class="td-bold">${d.firstname} ${d.lastname}</td>
      <td><span class="chip ${d.role==='admin'?'ch-purple':d.role==='driver'?'ch-green':'ch-gray'}">${roleLabel[d.role]||d.role}</span></td>
      <td>${d.phone?`<a href="tel:${d.phone}" style="color:var(--accent);font-size:12px">${d.phone}</a>`:'â€”'}</td>
      <td class="td-gray" style="font-size:12px">${d.email||'â€”'}</td>
      <td style="font-weight:700">${count}</td>
      <td><span class="chip ${d.status==='active'?'ch-green':'ch-red'}">${d.status==='active'?'âœ… Actif':'â›” Inactif'}</span></td>
      <td><div style="display:flex;gap:5px">
        <button class="btn btn-g btn-sm" onclick="editDriver('${d.id}')">âœï¸</button>
        <button class="btn btn-d btn-sm" onclick="confirmDelete('driver','${d.id}','${(d.firstname+' '+d.lastname).replace(/'/g,"\\'")}')">ğŸ—‘ï¸</button>
      </div></td>
    </tr>`;
  }).join('')
  : `<tr><td colspan="7"><div class="empty"><div class="empty-ico">ğŸ‘¤</div><div class="empty-ttl">Aucun membre d'Ã©quipe</div></div></td></tr>`;
};

window.driverFormMode = (mode, data={}) => {
  document.getElementById('driver-form-title').textContent = mode==='new' ? 'ğŸ‘¤ Nouveau membre' : 'âœï¸ Modifier le membre';
  document.getElementById('btn-save-driver').textContent   = mode==='new' ? 'âœ“ Ajouter' : 'âœ“ Enregistrer';
  document.getElementById('df-id').value        = data.id||'';
  document.getElementById('df-firstname').value = data.firstname||'';
  document.getElementById('df-lastname').value  = data.lastname||'';
  document.getElementById('df-email').value     = data.email||'';
  document.getElementById('df-phone').value     = data.phone||'';
  document.getElementById('df-role').value      = data.role||'driver';
  document.getElementById('df-status').value    = data.status||'active';
  document.getElementById('df-notes').value     = data.notes||'';
};

window.editDriver = id => {
  const d = STATE.drivers.find(x=>x.id===id);
  if (d) { driverFormMode('edit', d); openModal('modal-driver-form'); }
};

window.saveDriver = async () => {
  const id = document.getElementById('df-id').value;
  const fn = document.getElementById('df-firstname').value.trim();
  const ln = document.getElementById('df-lastname').value.trim();
  if (!fn||!ln) { toast('PrÃ©nom et nom requis','err'); return; }
  const data = {
    firstname:fn, lastname:ln,
    email:document.getElementById('df-email').value.trim(),
    phone:document.getElementById('df-phone').value.trim(),
    role:document.getElementById('df-role').value,
    status:document.getElementById('df-status').value,
    notes:document.getElementById('df-notes').value.trim(),
    updatedAt:serverTimestamp(),
  };
  try {
    if (id) { await updateDoc(doc(db,'drivers',id),data); toast('Membre mis Ã  jour âœ…','ok'); }
    else    { await addDoc(collection(db,'drivers'),{...data,createdAt:serverTimestamp()}); toast('Membre ajoutÃ© âœ…','ok'); }
    closeModal('modal-driver-form');
  } catch(e) { toast(e.message,'err'); }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INCIDENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let incFilter = 'all';
window.setIncFilter = (f,btn) => {
  incFilter=f;
  document.querySelectorAll('#page-incidents .filter-btn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  renderIncidents();
};

window.renderIncidents = () => {
  let list = STATE.incidents;
  if (incFilter!=='all') list = list.filter(i=>i.status===incFilter);
  const el = document.getElementById('incidents-list');
  if (!el) return;
  const typeLabel = {damage:'ğŸ”¨ Dommage',missing:'ğŸ“¦ Manquant',wrong_address:'ğŸ“ Mauvaise adresse',refused:'ğŸš« RefusÃ©',other:'â“ Autre'};
  const stCfg = {open:{chip:'ch-red',label:'ğŸ”´ Ouvert'},in_review:{chip:'ch-amber',label:'ğŸŸ¡ En cours'},resolved:{chip:'ch-green',label:'âœ… RÃ©solu'}};
  el.innerHTML = list.length ? list.map(i=>{
    const sc = stCfg[i.status]||stCfg.open;
    return `<div style="background:var(--surf);border:1px solid ${i.status==='open'?'rgba(239,68,68,.2)':'var(--border)'};border-radius:var(--r);padding:14px;margin-bottom:8px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap">
        <span style="font-size:12px;font-weight:700;font-family:var(--mono)">${typeLabel[i.type]||i.type||'Incident'}</span>
        <span class="chip ${sc.chip}">${sc.label}</span>
        ${i.deliveryRef?`<span class="chip ch-gray">${i.deliveryRef}</span>`:''}
        <span style="margin-left:auto;font-size:10px;color:var(--text3);font-family:var(--mono)">${tsRelative(i.createdAt)}</span>
      </div>
      <div style="font-size:13px;margin-bottom:8px">${i.description||'â€”'}</div>
      <div style="font-size:11px;color:var(--text2);font-family:var(--mono);display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        ${i.driverName?`<span>ğŸš› ${i.driverName}</span>`:''}
        ${i.status!=='resolved'?`<button class="btn btn-ok btn-xs" style="margin-left:auto" onclick="resolveIncident('${i.id}')">âœ“ RÃ©soudre</button>`:''}
      </div>
    </div>`;
  }).join('')
  : `<div class="empty"><div class="empty-ico">ğŸš¨</div><div class="empty-ttl">Aucun incident${incFilter!=='all'?' dans cette catÃ©gorie':''}</div></div>`;
};

window.resolveIncident = async id => {
  try {
    await updateDoc(doc(db,'incidents',id),{status:'resolved',resolvedAt:serverTimestamp(),resolvedBy:STATE.user?.uid});
    toast('Incident rÃ©solu âœ…','ok');
  } catch(e) { toast(e.message,'err'); }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DELETE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COLLECTIONS = {client:'clients',product:'products',livraison:'livraisons',driver:'drivers',tournee:'tournees'};
window.confirmDelete = (type, id, name) => {
  document.getElementById('confirm-title').textContent = `ğŸ—‘ï¸ Supprimer ?`;
  document.getElementById('confirm-msg').textContent   = `Voulez-vous vraiment supprimer "${name}" ? Cette action est irrÃ©versible.`;
  document.getElementById('btn-confirm-ok').onclick    = () => doDelete(type, id);
  openModal('modal-confirm');
};
async function doDelete(type, id) {
  try {
    await deleteDoc(doc(db, COLLECTIONS[type], id));
    toast('SupprimÃ© âœ…','ok');
    closeModal('modal-confirm');
  } catch(e) { toast(e.message,'err'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARAMETRES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadSettings() {
  const s = JSON.parse(localStorage.getItem('erp_settings')||'{}');
  Object.assign(STATE.settings, s);
  document.getElementById('p-company').value = STATE.settings.company||'';
  document.getElementById('p-addr').value    = STATE.settings.address||'';
  document.getElementById('p-phone').value   = STATE.settings.phone||'';
  document.getElementById('p-siret').value   = STATE.settings.siret||'';
}
window.saveSettings = () => {
  STATE.settings = {
    company:document.getElementById('p-company').value.trim(),
    address:document.getElementById('p-addr').value.trim(),
    phone:document.getElementById('p-phone').value.trim(),
    siret:document.getElementById('p-siret').value.trim(),
  };
  localStorage.setItem('erp_settings', JSON.stringify(STATE.settings));
  toast('ParamÃ¨tres enregistrÃ©s âœ…','ok');
};
function renderParamStats() {
  document.getElementById('p-stats').innerHTML = [
    {lbl:'Clients',val:STATE.clients.length},
    {lbl:'Produits',val:STATE.products.length},
    {lbl:'Livraisons',val:STATE.livraisons.length},
    {lbl:'Membres Ã©quipe',val:STATE.drivers.length},
  ].map(s=>`<div style="display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--border);font-size:13px"><span style="color:var(--text2)">${s.lbl}</span><span style="font-weight:700">${s.val}</span></div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SELECTS POPULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateClientSelects() {
  ['lf-client'].forEach(id => {
    const el = document.getElementById(id); if (!el) return;
    const cur = el.value;
    el.innerHTML = '<option value="">â€” SÃ©lectionner un client â€”</option>'
      + STATE.clients.filter(c=>c.status==='active').map(c=>`<option value="${c.id}" ${c.id===cur?'selected':''}>${c.company}</option>`).join('');
  });
}
function populateDriverSelects() {
  ['lf-driver','tf-driver'].forEach(id => {
    const el = document.getElementById(id); if (!el) return;
    const cur = el.value;
    const placeholder = id==='lf-driver' ? 'â€” Non assignÃ© â€”' : 'â€” SÃ©lectionner â€”';
    el.innerHTML = `<option value="">${placeholder}</option>`
      + STATE.drivers.filter(d=>d.status==='active').map(d=>`<option value="${d.id}" ${d.id===cur?'selected':''}>${d.firstname} ${d.lastname}</option>`).join('');
  });
}
function populateProductSelects() {
  const el = document.getElementById('mv-product'); if (!el) return;
  const cur = el.value;
  el.innerHTML = '<option value="">â€” SÃ©lectionner un produit â€”</option>'
    + STATE.products.map(p=>`<option value="${p.id}" ${p.id===cur?'selected':''}>${p.name} (${p.quantity} ${p.unit})</option>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAT LINES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addMatLine = (containerId, data={}) => {
  STATE.matLineCount++;
  const id  = STATE.matLineCount;
  const row = document.createElement('div');
  row.className = 'mat-line';
  row.innerHTML = `
    <input class="mat-name" type="text" list="ml-sug-${id}" placeholder="Nom de l'article" value="${data.name||''}">
    <datalist id="ml-sug-${id}">${STATE.products.map(p=>`<option value="${p.name}">`).join('')}</datalist>
    <input class="mat-qty" type="number" min="1" value="${data.qty||1}" placeholder="QtÃ©">
    <input class="mat-unit" type="text" value="${data.unit||''}" placeholder="unitÃ©" list="units-list">
    <button class="btn-rm" onclick="this.parentElement.remove()">âœ•</button>`;
  document.getElementById(containerId).appendChild(row);
};

// Units datalist
const unitsDatalist = document.createElement('datalist');
unitsDatalist.id = 'units-list';
['plaques','barres','sacs','panneaux','rouleaux','boÃ®tes','piÃ¨ces','mÂ²','ml'].forEach(u=>{
  const o = document.createElement('option'); o.value=u; unitsDatalist.appendChild(o);
});
document.body.appendChild(unitsDatalist);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addNotif(title, body, type='info') {
  const n = {id:Date.now().toString(),title,body,type,time:new Date(),read:false};
  STATE.notifications.unshift(n);
  if (STATE.notifications.length > 20) STATE.notifications.pop();
  renderNotifs();
}
function renderNotifs() {
  const unread = STATE.notifications.filter(n=>!n.read).length;
  document.getElementById('notif-dot').style.display = unread > 0 ? 'block' : 'none';
  const el = document.getElementById('notif-list');
  el.innerHTML = STATE.notifications.length
    ? STATE.notifications.map(n=>`<div class="np-item ${n.read?'':''}">
        <div style="display:flex;gap:8px;align-items:flex-start">
          ${!n.read?'<div style="width:6px;height:6px;border-radius:50%;background:var(--accent);flex-shrink:0;margin-top:4px"></div>':'<div style="width:6px;flex-shrink:0"></div>'}
          <div><div class="np-title">${n.title}</div><div class="np-body">${n.body}</div><div class="np-time">${tsRelative({seconds:Math.floor(n.time.getTime()/1000)})}</div></div>
        </div>
      </div>`).join('')
    : '<div class="empty" style="padding:20px"><div class="empty-sub">Aucune notification</div></div>';
}
window.clearNotifs = () => { STATE.notifications=[]; renderNotifs(); closeNotifs(); };

let notifOpen = false;
window.toggleNotifs = () => {
  notifOpen=!notifOpen;
  document.getElementById('notif-panel').classList.toggle('open',notifOpen);
  if (notifOpen) STATE.notifications.forEach(n=>n.read=true);
  renderNotifs();
};
function closeNotifs() { notifOpen=false; document.getElementById('notif-panel').classList.remove('open'); }
document.addEventListener('click',e=>{if(notifOpen&&!e.target.closest('#btn-notif')&&!e.target.closest('#notif-panel'))closeNotifs();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let darkMode = true;
window.toggleTheme = () => {
  darkMode=!darkMode;
  document.documentElement.setAttribute('data-theme', darkMode?'dark':'light');
  document.getElementById('btn-theme').textContent      = darkMode?'ğŸŒ™':'â˜€ï¸';
  document.getElementById('p-theme-btn').textContent    = darkMode?'ğŸŒ™ Sombre':'â˜€ï¸ Clair';
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openModal  = id => document.getElementById(id)?.classList.add('open');
window.closeModal = id => document.getElementById(id)?.classList.remove('open');
document.querySelectorAll('.modal-ov').forEach(ov=>ov.addEventListener('click',e=>{
  if(e.target===ov)ov.classList.remove('open');
}));
document.addEventListener('keydown',e=>{ if(e.key==='Escape') document.querySelectorAll('.modal-ov.open').forEach(m=>m.classList.remove('open')); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function lvStatusCfg(status) {
  const map = {
    pending:   {label:'â³ En attente', chip:'ch-amber',  color:'var(--amber)', tl:'amber'},
    assigned:  {label:'ğŸ“‹ AssignÃ©e',   chip:'ch-cyan',   color:'var(--cyan)',  tl:'blue'},
    in_transit:{label:'ğŸš› Transit',    chip:'ch-blue',   color:'var(--accent)',tl:'blue'},
    delivered: {label:'âœ… LivrÃ©e',     chip:'ch-green',  color:'var(--green)', tl:'green'},
    incident:  {label:'âš ï¸ Incident',   chip:'ch-red',    color:'var(--red)',   tl:'red'},
    cancelled: {label:'âŒ AnnulÃ©e',    chip:'ch-gray',   color:'var(--text3)', tl:'amber'},
  };
  return map[status] || map.pending;
}

function tsShort(ts) {
  if (!ts) return 'â€”';
  const d = ts.seconds ? new Date(ts.seconds*1000) : new Date(ts);
  return d.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
}

function tsRelative(ts) {
  if (!ts) return 'â€”';
  const d    = ts.seconds ? new Date(ts.seconds*1000) : new Date(ts);
  const diff = Date.now() - d.getTime();
  if (diff < 60000)  return 'il y a quelques secondes';
  if (diff < 3600000) return `il y a ${Math.floor(diff/60000)} min`;
  if (diff < 86400000) return `il y a ${Math.floor(diff/3600000)}h`;
  if (diff < 172800000) return 'hier';
  return d.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit'});
}

function genRef() {
  const d = new Date();
  const n = String(STATE.livraisons.length + 1).padStart(4,'0');
  return `REF-${d.getFullYear()}-${n}`;
}

window.copyAddr = addr => {
  navigator.clipboard?.writeText(addr);
  toast('Adresse copiÃ©e ğŸ“‹','ok');
};

window.toast = (msg, type='') => {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.getElementById('toast-area').appendChild(el);
  setTimeout(()=>el.remove(), 2700);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD SHORTCUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e => {
  if (e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.tagName==='SELECT') return;
  const shortcuts = {'1':'dashboard','2':'clients','3':'marchandises','4':'livraisons','5':'tournees','6':'equipe'};
  if (shortcuts[e.key]) showPage(shortcuts[e.key]);
});

</script>
</body>
</html>